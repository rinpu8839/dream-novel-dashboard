<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¤¢å°èª¬å‰µä½œãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 10px;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
}

.header {
    background: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.title {
    font-size: 24px;
    color: #333;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.sync-status {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    background: #e8f5e9;
    border-radius: 15px;
    font-size: 12px;
    color: #2e7d32;
    margin-left: auto;
}

.sync-status.syncing {
    background: #fff3e0;
    color: #f57c00;
}

.sync-status.error {
    background: #ffebee;
    color: #c62828;
}

.motivation-bar {
    width: 200px;
    height: 20px;
    background: #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}

.motivation-fill {
    height: 100%;
    background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
    transition: width 0.3s ease;
}

.pomodoro-timer {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: #ffe0f0;
    padding: 10px 20px;
    border-radius: 25px;
    font-size: 20px;
    font-weight: bold;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5a67d8;
    transform: translateY(-2px);
}

.btn-success {
    background: #48bb78;
    color: white;
}

.btn-danger {
    background: #f56565;
    color: white;
}

.btn-warning {
    background: #ed8936;
    color: white;
}

.genre-tabs {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    flex-wrap: wrap;
}

.genre-tab {
    padding: 8px 16px;
    background: #f0f0f0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.genre-tab.active {
    background: #667eea;
    color: white;
}

.task-card {
    background: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
    position: relative;
}

.task-card.overdue {
    border-left: 5px solid #ff4444;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 4px 15px rgba(255,0,0,0.1); }
    50% { box-shadow: 0 4px 25px rgba(255,0,0,0.3); }
    100% { box-shadow: 0 4px 15px rgba(255,0,0,0.1); }
}

.task-card:hover {
    transform: translateY(-3px);
}

.task-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.task-title {
    font-weight: bold;
    font-size: 16px;
    color: #333;
    cursor: pointer;
}

.task-deadline {
    padding: 4px 8px;
    border-radius: 5px;
    color: white;
    font-size: 12px;
}

.deadline-overdue {
    background: #ff4444;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 50%, 100% { opacity: 1; }
    25%, 75% { opacity: 0.7; }
}

.deadline-urgent {
    background: #f56565;
}

.deadline-soon {
    background: #ed8936;
}

.deadline-normal {
    background: #48bb78;
}

.progress-bar {
    width: 100%;
    height: 10px;
    background: #e0e0e0;
    border-radius: 5px;
    overflow: hidden;
    margin: 10px 0;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transition: width 0.3s ease;
}

.ai-advice {
    background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    border-left: 4px solid #fdcb6e;
}

.overdue-alert {
    background: linear-gradient(135deg, #ff6b6b 0%, #ff4444 100%);
    color: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    animation: shake 0.5s;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.stat-card {
    background: white;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.stat-number {
    font-size: 24px;
    font-weight: bold;
    color: #667eea;
}

.stat-label {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: 15px;
    padding: 25px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.checkbox {
    width: 20px;
    height: 20px;
    margin-right: 10px;
    cursor: pointer;
}

.completed {
    text-decoration: line-through;
    opacity: 0.6;
}

.today-progress {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
}

.pomodoro-dots {
    display: flex;
    gap: 5px;
    margin: 10px 0;
}

.pomodoro-dot {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background: #e0e0e0;
}

.pomodoro-dot.filled {
    background: #ff6b6b;
}

.calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    padding: 10px;
    background: white;
    border-radius: 10px;
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 1px solid #e0e0e0;
    border-radius: 5px;
    font-size: 12px;
    position: relative;
}

.calendar-day.today {
    background: #e6f3ff;
    border-color: #667eea;
}

.calendar-day-number {
    font-weight: bold;
}

.calendar-day-pomodoros {
    font-size: 10px;
    color: #667eea;
}

.subtask-item {
    padding: 5px 0;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.subtask-checkbox {
    width: 16px;
    height: 16px;
}

.quote-box {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    padding: 15px;
    border-radius: 10px;
    margin-top: 15px;
    font-style: italic;
    text-align: center;
}

.task-actions {
    display: flex;
    gap: 5px;
    margin-left: auto;
}

.btn-small {
    padding: 4px 8px;
    font-size: 12px;
}

.progress-section {
    background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    color: white;
}

.genre-progress {
    margin: 10px 0;
}

.genre-progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(255,255,255,0.3);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 5px;
}

.genre-progress-fill {
    height: 100%;
    background: white;
    transition: width 0.3s ease;
}

/* ãƒ¡ãƒ¢ã‚·ã‚¹ãƒ†ãƒ ã®æ–°ã—ã„ã‚¹ã‚¿ã‚¤ãƒ« */
.memo-section {
    background: white;
    border-radius: 15px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.memo-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.memo-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    border-bottom: 2px solid #e0e0e0;
    padding-bottom: 10px;
}

.memo-tab {
    padding: 8px 16px;
    background: #f0f0f0;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
}

.memo-tab.active {
    background: #667eea;
    color: white;
}

.memo-count {
    background: rgba(255,255,255,0.3);
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 11px;
}

.tag-input-container {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin: 10px 0;
}

.tag {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    background: #e3f2fd;
    color: #1976d2;
    border-radius: 15px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.tag:hover {
    background: #bbdefb;
}

.tag.selected {
    background: #667eea;
    color: white;
}

.tag-remove {
    cursor: pointer;
    opacity: 0.7;
}

.tag-remove:hover {
    opacity: 1;
}

.memo-item {
    background: #f9f9f9;
    border-left: 3px solid #667eea;
    padding: 12px;
    border-radius: 5px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.memo-item:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.memo-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    font-size: 11px;
    color: #666;
}

.memo-tags {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.memo-search {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.memo-search:focus {
    outline: none;
    border-color: #667eea;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
    .title {
        font-size: 18px;
    }
    
    .sync-status {
        font-size: 10px;
        padding: 3px 8px;
    }
    
    .pomodoro-timer {
        font-size: 16px;
        padding: 8px 15px;
    }
    
    .stats-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .modal-content {
        padding: 15px;
    }
    
    .memo-tabs {
        flex-wrap: wrap;
    }
    
    .memo-tab {
        font-size: 12px;
        padding: 6px 12px;
    }
}

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.fade-in {
    animation: fadeIn 0.3s ease;
}

/* é€šçŸ¥ã‚¹ã‚¿ã‚¤ãƒ« */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    z-index: 10000;
    animation: slideIn 0.5s ease;
    max-width: 300px;
}

.notification.success {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.notification.error {
    background: linear-gradient(135deg, #ff6b6b 0%, #ff4444 100%);
}

input[type="text"], input[type="date"], input[type="number"], select, textarea {
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border: 1px solid #ddd;
    border-radius: 5px;
}

textarea {
    resize: vertical;
}
</style>
</head>
<body>
<div class="container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <div class="title">
            <span>âœ¨</span>
            <span>å¤¢å°èª¬å‰µä½œãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
            <div class="sync-status" id="syncStatus">
                <span id="syncIcon">â˜ï¸</span>
                <span id="syncText">åŒæœŸæ¸ˆã¿</span>
            </div>
        </div>
        
        <!-- ãƒœã‚¿ãƒ³ç¾¤ -->
        <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
            <button class="btn btn-warning btn-small" onclick="downloadBackup()">
                ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
            </button>
            <button class="btn btn-success btn-small" onclick="uploadBackup()">
                ğŸ“‚ å¾©å…ƒ
            </button>
            <button class="btn btn-small" onclick="showThemeModal()" style="background: #9f7aea; color: white;">
                ğŸ¨ ãƒ†ãƒ¼ãƒ
            </button>
            <button class="btn btn-small" onclick="forceSyncData()" style="background: #00bcd4; color: white;">
                ğŸ”„ åŒæœŸ
            </button>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <div>
                <div style="font-size: 14px; color: #666;">ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³</div>
                <div class="motivation-bar">
                    <div class="motivation-fill" id="motivationBar" style="width: 75%;"></div>
                </div>
                <div id="motivationText" style="font-size: 12px; color: #888;">ã„ã„æ„Ÿã˜ï¼ 75%</div>
            </div>
            
            <div class="pomodoro-timer">
                <span>ğŸ…</span>
                <span id="pomodoroTime">25:00</span>
                <button class="btn btn-primary" onclick="togglePomodoro()">é–‹å§‹</button>
            </div>
        </div>
        
        <div class="genre-tabs">
            <div class="genre-tab active" onclick="selectGenre('å…¨ä½“')">å…¨ä½“</div>
            <div class="genre-tab" onclick="selectGenre('TRICK')">TRICK</div>
            <div class="genre-tab" onclick="selectGenre('KILLERS')">KILLERS</div>
            <button class="btn btn-success" onclick="showAddGenreModal()">+ ã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ </button>
        </div>
    </div>
    
    <!-- æœŸé™åˆ‡ã‚Œã‚¢ãƒ©ãƒ¼ãƒˆ -->
    <div id="overdueAlert" style="display: none;" class="overdue-alert">
        <h3>âš ï¸ æœŸé™ã‚’éããŸã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ï¼</h3>
        <div id="overdueList"></div>
        <button class="btn" style="background: white; color: #ff4444; margin-top: 10px;" onclick="rescheduleOverdue()">
            æœŸé™ã‚’å†è¨­å®šã™ã‚‹
        </button>
    </div>
    
    <!-- é€²æ—çŠ¶æ³ -->
    <div class="progress-section">
        <h3>ğŸ“Š ç¾åœ¨ã®é€²æ—çŠ¶æ³</h3>
        <div id="currentFocus" style="margin: 10px 0; font-size: 14px;"></div>
        <div id="genreProgressBars"></div>
    </div>
    
    <!-- ä»Šæ—¥ã®é€²æ— -->
    <div class="today-progress">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3>ğŸ“Š ä»Šæ—¥ã®é”æˆåº¦</h3>
                <div class="pomodoro-dots" id="todayProgress">
                    <div class="pomodoro-dot"></div>
                    <div class="pomodoro-dot"></div>
                    <div class="pomodoro-dot"></div>
                    <div class="pomodoro-dot"></div>
                    <div class="pomodoro-dot"></div>
                    <div class="pomodoro-dot"></div>
                    <div class="pomodoro-dot"></div>
                    <div class="pomodoro-dot"></div>
                </div>
                <div style="font-size: 14px; color: #666;">
                    <span id="todayCount">0</span>/8 ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­å®Œäº†
                </div>
            </div>
            <button class="btn btn-primary" onclick="showCalendarModal()">
                ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º
            </button>
        </div>
    </div>
    
    <!-- é€±é–“ãƒ“ãƒ¥ãƒ¼ -->
    <div class="weekly-view" style="background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
        <h3>ğŸ“… ä»Šé€±ã®äºˆå®š</h3>
        <div id="weeklySchedule"></div>
    </div>
    
    <!-- AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ -->
    <div class="ai-advice">
        <h3 style="margin-bottom: 10px;">ğŸ¤– AIæ¨å¥¨: å„ªå…ˆã‚¿ã‚¹ã‚¯</h3>
        <div id="aiAdvice">
            åˆ†æä¸­...
        </div>
    </div>
    
    <!-- ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ -->
    <div id="taskList"></div>
    
    <!-- æ”¹è‰¯ç‰ˆãƒ¡ãƒ¢ã‚·ã‚¹ãƒ†ãƒ  -->
    <div class="memo-section">
        <div class="memo-header">
            <h3 style="color: #333;">ğŸ’¡ ã‚¢ã‚¤ãƒ‡ã‚¢ãƒ¡ãƒ¢ç®¡ç†</h3>
            <button class="btn btn-primary btn-small" onclick="showMemoModal()">
                + æ–°è¦ãƒ¡ãƒ¢
            </button>
        </div>
        
        <input type="text" class="memo-search" id="memoSearch" placeholder="ğŸ” ãƒ¡ãƒ¢ã‚’æ¤œç´¢..." onkeyup="searchMemos()">
        
        <div class="memo-tabs">
            <div class="memo-tab active" onclick="filterMemosByTab('all')">
                ã™ã¹ã¦ <span class="memo-count" id="countAll">0</span>
            </div>
            <div class="memo-tab" onclick="filterMemosByTab('idea')">
                ğŸ’­ ã‚¢ã‚¤ãƒ‡ã‚¢ <span class="memo-count" id="countIdea">0</span>
            </div>
            <div class="memo-tab" onclick="filterMemosByTab('character')">
                ğŸ‘¤ ã‚­ãƒ£ãƒ©è¨­å®š <span class="memo-count" id="countCharacter">0</span>
            </div>
            <div class="memo-tab" onclick="filterMemosByTab('plot')">
                ğŸ“ ãƒ—ãƒ­ãƒƒãƒˆ <span class="memo-count" id="countPlot">0</span>
            </div>
            <div class="memo-tab" onclick="filterMemosByTab('writing')">
                âœï¸ åŸ·ç­†ä¸­ <span class="memo-count" id="countWriting">0</span>
            </div>
            <div class="memo-tab" onclick="filterMemosByTab('completed')">
                âœ… å®Œäº† <span class="memo-count" id="countCompleted">0</span>
            </div>
        </div>
        
        <div id="memoList" style="max-height: 400px; overflow-y: auto;"></div>
    </div>
    
    <!-- çµ±è¨ˆ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="completedCount">0</div>
            <div class="stat-label">å®Œäº†ã‚¿ã‚¹ã‚¯</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="pomodoroCount">0</div>
            <div class="stat-label">ç·ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="wordCount">0</div>
            <div class="stat-label">åŸ·ç­†æ–‡å­—æ•°</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="memoCount">0</div>
            <div class="stat-label">ãƒ¡ãƒ¢æ•°</div>
        </div>
    </div>
    
    <!-- åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
    <div class="analysis-dashboard" style="background: white; border-radius: 15px; padding: 20px; margin-top: 20px;">
        <h3 style="color: #333; margin-bottom: 15px;">ğŸ“Š è©³ç´°åˆ†æ</h3>
        
        <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">
            <button class="analysis-tab active" onclick="showAnalysisTab('patterns')" style="padding: 8px 16px; border: none; background: #667eea; color: white; border-radius: 5px; cursor: pointer;">
                ğŸ“ˆ ä½œæ¥­ãƒ‘ã‚¿ãƒ¼ãƒ³
            </button>
            <button class="analysis-tab" onclick="showAnalysisTab('productivity')" style="padding: 8px 16px; border: none; background: #e0e0e0; color: #333; border-radius: 5px; cursor: pointer;">
                â° ç”Ÿç”£æ€§åˆ†æ
            </button>
            <button class="analysis-tab" onclick="showAnalysisTab('comparison')" style="padding: 8px 16px; border: none; background: #e0e0e0; color: #333; border-radius: 5px; cursor: pointer;">
                ğŸ“Š ã‚¸ãƒ£ãƒ³ãƒ«æ¯”è¼ƒ
            </button>
        </div>
        
        <div id="analysisContent"></div>
    </div>
    
    <!-- å®Ÿç¸¾ãƒãƒƒã‚¸ -->
    <div class="achievement-section" style="background: white; border-radius: 10px; padding: 15px; margin-top: 20px;">
        <h3 style="color: #333; margin-bottom: 10px;">ğŸ† ç²å¾—ãƒãƒƒã‚¸</h3>
        <div id="achievementBadges" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
    </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ç¾¤ -->

<!-- ãƒ¡ãƒ¢è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="memoModal" class="modal">
    <div class="modal-content">
        <h3 id="memoModalTitle">æ–°è¦ãƒ¡ãƒ¢ä½œæˆ</h3>
        
        <textarea id="memoInput" placeholder="ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å…¥åŠ›..." rows="5" style="margin-top: 10px;"></textarea>
        
        <div style="margin-top: 15px;">
            <label style="font-size: 14px; color: #666;">ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠ</label>
            <select id="memoGenre" style="margin-top: 5px;">
                <option value="">æœªåˆ†é¡</option>
            </select>
        </div>
        
        <div style="margin-top: 15px;">
            <label style="font-size: 14px; color: #666;">ã‚¿ã‚°é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</label>
            <div class="tag-input-container" id="memoTags">
                <div class="tag" data-tag="idea" onclick="toggleTag(this)">ğŸ’­ ã‚¢ã‚¤ãƒ‡ã‚¢</div>
                <div class="tag" data-tag="character" onclick="toggleTag(this)">ğŸ‘¤ ã‚­ãƒ£ãƒ©è¨­å®š</div>
                <div class="tag" data-tag="plot" onclick="toggleTag(this)">ğŸ“ ãƒ—ãƒ­ãƒƒãƒˆ</div>
                <div class="tag" data-tag="dialogue" onclick="toggleTag(this)">ğŸ’¬ ã‚»ãƒªãƒ•</div>
                <div class="tag" data-tag="scene" onclick="toggleTag(this)">ğŸ¬ ã‚·ãƒ¼ãƒ³</div>
                <div class="tag" data-tag="worldbuilding" onclick="toggleTag(this)">ğŸŒ ä¸–ç•Œè¦³</div>
                <div class="tag" data-tag="writing" onclick="toggleTag(this)">âœï¸ åŸ·ç­†ä¸­</div>
                <div class="tag" data-tag="completed" onclick="toggleTag(this)">âœ… å®Œäº†</div>
                <div class="tag" data-tag="important" onclick="toggleTag(this)">â­ é‡è¦</div>
                <div class="tag" data-tag="reference" onclick="toggleTag(this)">ğŸ“š å‚è€ƒè³‡æ–™</div>
            </div>
        </div>
        
        <div style="margin-top: 15px;">
            <label style="font-size: 14px; color: #666;">ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
            <input type="text" id="customTags" placeholder="ä¾‹: å¤¢ä¸»è¨­å®š, ç¬¬1ç« , ä¼ç·š">
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-primary" onclick="saveMemoWithTags()" style="flex: 1;">ä¿å­˜</button>
            <button class="btn" onclick="hideModal('memoModal')" style="flex: 1; background: #ccc;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>

<!-- ã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="genreModal" class="modal">
    <div class="modal-content">
        <h3>æ–°è¦ã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ </h3>
        <input type="text" id="genreInput" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«åã‚’å…¥åŠ›">
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn btn-primary" onclick="addGenre()" style="flex: 1;">è¿½åŠ </button>
            <button class="btn" onclick="hideModal('genreModal')" style="flex: 1; background: #ccc;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>

<!-- ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="taskModal" class="modal">
    <div class="modal-content">
        <h3 id="taskModalTitle">ã‚¿ã‚¹ã‚¯è¿½åŠ </h3>
        <input type="text" id="taskTitle" placeholder="ã‚¿ã‚¹ã‚¯å">
        <select id="taskType">
            <option value="transcript">ã‚»ãƒªãƒ•èµ·ã“ã—</option>
            <option value="analysis">åˆ†æ</option>
            <option value="planning">æ§‹æˆãƒ»ä¼ç”»</option>
            <option value="writing">åŸ·ç­†</option>
            <option value="other">ãã®ä»–</option>
        </select>
        <input type="date" id="taskStartDate">
        <input type="date" id="taskEndDate">
        <input type="number" id="taskPomodoros" placeholder="äºˆå®šãƒãƒ¢ãƒ‰ãƒ¼ãƒ­æ•°" min="1" value="4">
        <select id="taskPriority">
            <option value="high">å„ªå…ˆåº¦: é«˜</option>
            <option value="medium">å„ªå…ˆåº¦: ä¸­</option>
            <option value="low">å„ªå…ˆåº¦: ä½</option>
        </select>
        <textarea id="taskDetails" placeholder="ä½œæ¥­è©³ç´°" rows="3"></textarea>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn btn-primary" onclick="saveTask()" style="flex: 1;">ä¿å­˜</button>
            <button class="btn" onclick="hideModal('taskModal')" style="flex: 1; background: #ccc;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>

<!-- ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <h3 id="detailTitle">ã‚¿ã‚¹ã‚¯è©³ç´°</h3>
        <div id="detailContent"></div>
        <div class="quote-box" id="motivationalQuote"></div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn btn-primary" onclick="startDetailPomodoro()" style="flex: 1;">ä½œæ¥­é–‹å§‹</button>
            <button class="btn" onclick="hideModal('detailModal')" style="flex: 1; background: #ccc;">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="calendarModal" class="modal">
    <div class="modal-content">
        <h3>ğŸ“… æœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
        <div id="calendarContent"></div>
        <div style="margin-top: 15px;">
            <button class="btn" onclick="hideModal('calendarModal')" style="width: 100%; background: #ccc;">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<!-- ãƒ†ãƒ¼ãƒé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="themeModal" class="modal">
    <div class="modal-content">
        <h3>ğŸ¨ ãƒ†ãƒ¼ãƒé¸æŠ</h3>
        <div id="themeOptions" style="display: grid; gap: 10px; margin-top: 15px;"></div>
        <button class="btn" onclick="hideModal('themeModal')" style="width: 100%; margin-top: 15px; background: #ccc;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
// ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°å®šç¾© =====
let tasks = {};
let genres = ['TRICK', 'KILLERS'];
let selectedGenre = 'å…¨ä½“';
let pomodoroActive = false;
let pomodoroTime = 25 * 60;
let motivationLevel = 75;
let pomodoroInterval;
let currentTaskId = null;
let currentEditGenre = null;
let currentDetailTask = null;
let dailyProgress = {};
let memos = [];
let currentMemoFilter = 'all';
let currentEditMemoId = null;
let syncInterval;

const STORAGE_KEY = 'dreamNovelData';
const SYNC_KEY = 'dreamNovelSync';
const MEMO_KEY = 'dreamNovelMemos';

// åŠ±ã¾ã—ã®è¨€è‘‰
const quotes = [
    "ä¸€æ­©ãšã¤é€²ã‚ã°ã€å¿…ãšç›®æ¨™ã«åˆ°é”ã§ãã¾ã™ï¼",
    "ä»Šæ—¥ã®å°ã•ãªåŠªåŠ›ãŒã€æ˜æ—¥ã®å¤§ããªæˆæœã«ãªã‚Šã¾ã™ã€‚",
    "å‰µä½œã¯é­‚ã®è¡¨ç¾ã€‚ã‚ãªãŸã®ç‰©èªã‚’ä¸–ç•ŒãŒå¾…ã£ã¦ã„ã¾ã™ã€‚",
    "å®Œç’§ã˜ã‚ƒãªãã¦ã„ã„ã€‚ã¾ãšå§‹ã‚ã‚‹ã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚",
    "ã‚ãªãŸã®æƒ³åƒåŠ›ã¯ç„¡é™å¤§ã€‚ä»Šæ—¥ã‚‚ç´ æ•µãªç‰©èªã‚’ç´¡ãã¾ã—ã‚‡ã†ã€‚",
    "ä¼‘æ†©ã‚‚å‰µä½œã®ä¸€éƒ¨ã€‚ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã¦ã€ã¾ãŸé ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼",
    "ã©ã‚“ãªå‰å¤§ãªä½œå®¶ã‚‚ã€ä¸€æ–‡å­—ã‹ã‚‰å§‹ã‚ã¾ã—ãŸã€‚",
    "ä»Šæ›¸ã„ã¦ã„ã‚‹ãã®ä¸€è¡ŒãŒã€èª°ã‹ã®å¿ƒã‚’å‹•ã‹ã™ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚",
    "ç–²ã‚ŒãŸã¨ãã¯ã€ãªãœå§‹ã‚ãŸã®ã‹æ€ã„å‡ºã—ã¦ãã ã•ã„ã€‚",
    "ã‚ãªãŸã«ã—ã‹æ›¸ã‘ãªã„ç‰©èªãŒã‚ã‚Šã¾ã™ã€‚è‡ªä¿¡ã‚’æŒã£ã¦ï¼"
];

// ===== åŒæœŸæ©Ÿèƒ½ =====
function generateSyncId() {
    if (!localStorage.getItem('syncId')) {
        const syncId = 'sync_' + Math.random().toString(36).substr(2, 9) + Date.now();
        localStorage.setItem('syncId', syncId);
    }
    return localStorage.getItem('syncId');
}

function saveToCloud() {
    const syncId = generateSyncId();
    const dataToSync = {
        tasks: tasks,
        genres: genres,
        dailyProgress: dailyProgress,
        memos: memos,
        selectedGenre: selectedGenre,
        motivationLevel: motivationLevel,
        lastSynced: new Date().toISOString(),
        deviceInfo: navigator.userAgent
    };
    
    // LocalStorageã‚’ä½¿ã£ãŸç–‘ä¼¼ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ
    localStorage.setItem(SYNC_KEY + '_' + syncId, JSON.stringify(dataToSync));
    
    // åŒæœŸçŠ¶æ…‹ã‚’æ›´æ–°
    updateSyncStatus('synced');
    
    return true;
}

function loadFromCloud() {
    const syncId = generateSyncId();
    const cloudData = localStorage.getItem(SYNC_KEY + '_' + syncId);
    
    if (cloudData) {
        try {
            const data = JSON.parse(cloudData);
            
            // æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‹ãƒã‚§ãƒƒã‚¯
            const localData = localStorage.getItem(STORAGE_KEY);
            if (localData) {
                const local = JSON.parse(localData);
                if (local.lastSaved && data.lastSynced) {
                    if (new Date(local.lastSaved) > new Date(data.lastSynced)) {
                        return false; // ãƒ­ãƒ¼ã‚«ãƒ«ã®æ–¹ãŒæ–°ã—ã„
                    }
                }
            }
            
            tasks = data.tasks || {};
            genres = data.genres || ['TRICK', 'KILLERS'];
            dailyProgress = data.dailyProgress || {};
            memos = data.memos || [];
            selectedGenre = data.selectedGenre || 'å…¨ä½“';
            motivationLevel = data.motivationLevel || 75;
            
            return true;
        } catch (e) {
            console.error('åŒæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
            return false;
        }
    }
    return false;
}

function updateSyncStatus(status) {
    const syncIcon = document.getElementById('syncIcon');
    const syncText = document.getElementById('syncText');
    const syncStatus = document.getElementById('syncStatus');
    
    switch(status) {
        case 'syncing':
            syncIcon.textContent = 'ğŸ”„';
            syncText.textContent = 'åŒæœŸä¸­...';
            syncStatus.className = 'sync-status syncing';
            break;
        case 'synced':
            syncIcon.textContent = 'â˜ï¸';
            syncText.textContent = 'åŒæœŸæ¸ˆã¿';
            syncStatus.className = 'sync-status';
            break;
        case 'error':
            syncIcon.textContent = 'âš ï¸';
            syncText.textContent = 'ã‚¨ãƒ©ãƒ¼';
            syncStatus.className = 'sync-status error';
            break;
    }
}

function forceSyncData() {
    updateSyncStatus('syncing');
    
    setTimeout(() => {
        if (saveToCloud()) {
            showNotification('åŒæœŸå®Œäº†', 'ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«åŒæœŸã•ã‚Œã¾ã—ãŸ', 'success');
            updateSyncStatus('synced');
        } else {
            showNotification('åŒæœŸã‚¨ãƒ©ãƒ¼', 'åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            updateSyncStatus('error');
        }
    }, 1000);
}

// ===== ãƒ¡ãƒ¢æ©Ÿèƒ½ã®æ‹¡å¼µ =====
function showMemoModal(memoId = null) {
    currentEditMemoId = memoId;
    
    // ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠè‚¢ã‚’æ›´æ–°
    const genreSelect = document.getElementById('memoGenre');
    genreSelect.innerHTML = '<option value="">æœªåˆ†é¡</option>';
    genres.forEach(genre => {
        genreSelect.innerHTML += `<option value="${genre}">${genre}</option>`;
    });
    
    if (memoId) {
        const memo = memos.find(m => m.id === memoId);
        if (memo) {
            document.getElementById('memoModalTitle').textContent = 'ãƒ¡ãƒ¢ã‚’ç·¨é›†';
            document.getElementById('memoInput').value = memo.text;
            document.getElementById('memoGenre').value = memo.genre || '';
            document.getElementById('customTags').value = memo.customTags ? memo.customTags.join(', ') : '';
            
            // ã‚¿ã‚°ã®é¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒ
            document.querySelectorAll('#memoTags .tag').forEach(tag => {
                tag.classList.remove('selected');
                if (memo.tags && memo.tags.includes(tag.dataset.tag)) {
                    tag.classList.add('selected');
                }
            });
        }
    } else {
        document.getElementById('memoModalTitle').textContent = 'æ–°è¦ãƒ¡ãƒ¢ä½œæˆ';
        document.getElementById('memoInput').value = '';
        document.getElementById('memoGenre').value = selectedGenre !== 'å…¨ä½“' ? selectedGenre : '';
        document.getElementById('customTags').value = '';
        document.querySelectorAll('#memoTags .tag').forEach(tag => {
            tag.classList.remove('selected');
        });
    }
    
    document.getElementById('memoModal').style.display = 'flex';
}

function toggleTag(element) {
    element.classList.toggle('selected');
}

function saveMemoWithTags() {
    const text = document.getElementById('memoInput').value.trim();
    if (!text) {
        showNotification('ã‚¨ãƒ©ãƒ¼', 'ãƒ¡ãƒ¢å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
    }
    
    const selectedTags = [];
    document.querySelectorAll('#memoTags .tag.selected').forEach(tag => {
        selectedTags.push(tag.dataset.tag);
    });
    
    const customTagsInput = document.getElementById('customTags').value;
    const customTags = customTagsInput ? customTagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
    
    const memo = {
        id: currentEditMemoId || Date.now(),
        text: text,
        genre: document.getElementById('memoGenre').value,
        tags: selectedTags,
        customTags: customTags,
        date: currentEditMemoId ? 
            memos.find(m => m.id === currentEditMemoId).date : 
            new Date().toISOString(),
        lastModified: new Date().toISOString()
    };
    
    if (currentEditMemoId) {
        const index = memos.findIndex(m => m.id === currentEditMemoId);
        if (index !== -1) {
            memos[index] = memo;
        }
    } else {
        memos.unshift(memo);
    }
    
    saveMemos();
    displayMemos();
    hideModal('memoModal');
    showNotification('ä¿å­˜å®Œäº†', 'ãƒ¡ãƒ¢ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ', 'success');
}

function saveMemos() {
    localStorage.setItem(MEMO_KEY, JSON.stringify(memos));
    updateMemoCount();
    autoSave();
}

function loadMemos() {
    const saved = localStorage.getItem(MEMO_KEY);
    if (saved) {
        try {
            memos = JSON.parse(saved);
        } catch (e) {
            memos = [];
        }
    }
}

function displayMemos() {
    const container = document.getElementById('memoList');
    if (!container) return;
    
    let filteredMemos = [...memos];
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    if (currentMemoFilter !== 'all') {
        filteredMemos = filteredMemos.filter(memo => 
            memo.tags && memo.tags.includes(currentMemoFilter)
        );
    }
    
    // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
    const searchTerm = document.getElementById('memoSearch').value.toLowerCase();
    if (searchTerm) {
        filteredMemos = filteredMemos.filter(memo => 
            memo.text.toLowerCase().includes(searchTerm) ||
            (memo.genre && memo.genre.toLowerCase().includes(searchTerm)) ||
            (memo.customTags && memo.customTags.some(tag => tag.toLowerCase().includes(searchTerm)))
        );
    }
    
    container.innerHTML = filteredMemos.map(memo => {
        const allTags = [...(memo.tags || []), ...(memo.customTags || [])];
        const tagIcons = {
            idea: 'ğŸ’­',
            character: 'ğŸ‘¤',
            plot: 'ğŸ“',
            dialogue: 'ğŸ’¬',
            scene: 'ğŸ¬',
            worldbuilding: 'ğŸŒ',
            writing: 'âœï¸',
            completed: 'âœ…',
            important: 'â­',
            reference: 'ğŸ“š'
        };
        
        return `
            <div class="memo-item fade-in">
                <div style="white-space: pre-wrap;">${memo.text}</div>
                <div class="memo-meta">
                    <div class="memo-tags">
                        ${memo.genre ? `<span class="tag" style="background: #e8f5e9; color: #2e7d32;">${memo.genre}</span>` : ''}
                        ${allTags.map(tag => `
                            <span class="tag" style="padding: 2px 8px; font-size: 11px;">
                                ${tagIcons[tag] || ''} ${tag}
                            </span>
                        `).join('')}
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span>${new Date(memo.date).toLocaleDateString('ja-JP')}</span>
                        <button onclick="showMemoModal(${memo.id})" style="padding: 2px 8px; background: #667eea; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">ç·¨é›†</button>
                        <button onclick="deleteMemo(${memo.id})" style="padding: 2px 8px; background: #ff6b6b; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">å‰Šé™¤</button>
                    </div>
                </div>
            </div>
        `;
    }).join('') || '<div style="text-align: center; color: #999; padding: 20px;">ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    
    updateMemoCount();
}

function filterMemosByTab(filter) {
    currentMemoFilter = filter;
    
    // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('.memo-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.closest('.memo-tab').classList.add('active');
    
    displayMemos();
}

function searchMemos() {
    displayMemos();
}

function updateMemoCount() {
    const counts = {
        all: memos.length,
        idea: 0,
        character: 0,
        plot: 0,
        writing: 0,
        completed: 0
    };
    
    memos.forEach(memo => {
        if (memo.tags) {
            memo.tags.forEach(tag => {
                if (counts.hasOwnProperty(tag)) {
                    counts[tag]++;
                }
            });
        }
    });
    
    Object.keys(counts).forEach(key => {
        const element = document.getElementById('count' + key.charAt(0).toUpperCase() + key.slice(1));
        if (element) {
            element.textContent = counts[key];
        }
    });
    
    document.getElementById('memoCount').textContent = memos.length;
}

function deleteMemo(id) {
    if (confirm('ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        memos = memos.filter(m => m.id !== id);
        saveMemos();
        displayMemos();
        showNotification('å‰Šé™¤å®Œäº†', 'ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    }
}

// ===== é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ  =====
function showNotification(title, message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">${title}</div>
        <div style="font-size: 14px;">${message}</div>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.5s ease';
        setTimeout(() => notification.remove(), 500);
    }, 3000);
}

// ===== ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–é–¢æ•° =====
function saveAllData() {
    const dataToSave = {
        tasks: tasks,
        genres: genres,
        dailyProgress: dailyProgress,
        selectedGenre: selectedGenre,
        motivationLevel: motivationLevel,
        lastSaved: new Date().toISOString()
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
    
    // ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ
    if (navigator.onLine) {
        saveToCloud();
    }
}

function loadAllData() {
    // ã¾ãšã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ã‚’è©¦ã¿ã‚‹
    if (navigator.onLine && loadFromCloud()) {
        console.log('ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
        return true;
    }
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
    const savedData = localStorage.getItem(STORAGE_KEY);
    if (savedData) {
        try {
            const data = JSON.parse(savedData);
            tasks = data.tasks || {};
            genres = data.genres || ['TRICK', 'KILLERS'];
            dailyProgress = data.dailyProgress || {};
            selectedGenre = data.selectedGenre || 'å…¨ä½“';
            motivationLevel = data.motivationLevel || 75;
            
            validateData();
            console.log('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', data.lastSaved);
            return true;
        } catch (e) {
            console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
            return false;
        }
    }
    return false;
}

function validateData() {
    Object.keys(tasks).forEach(genre => {
        if (!genres.includes(genre)) {
            console.log(`ã‚¸ãƒ£ãƒ³ãƒ«ã€Œ${genre}ã€ã‚’å¾©å…ƒ`);
            genres.push(genre);
        }
    });
    
    genres.forEach(genre => {
        if (!tasks[genre]) {
            tasks[genre] = [];
        }
    });
}

function rebuildGenreTabs() {
    const tabsContainer = document.querySelector('.genre-tabs');
    if (!tabsContainer) return;
    
    const existingTabs = tabsContainer.querySelectorAll('.genre-tab');
    existingTabs.forEach(tab => tab.remove());
    
    const allTab = document.createElement('div');
    allTab.className = selectedGenre === 'å…¨ä½“' ? 'genre-tab active' : 'genre-tab';
    allTab.textContent = 'å…¨ä½“';
    allTab.onclick = () => selectGenre('å…¨ä½“');
    tabsContainer.insertBefore(allTab, tabsContainer.firstChild);
    
    genres.forEach(genre => {
        const tab = document.createElement('div');
        tab.className = selectedGenre === genre ? 'genre-tab active' : 'genre-tab';
        tab.textContent = genre;
        tab.onclick = () => selectGenre(genre);
        tabsContainer.insertBefore(tab, tabsContainer.lastElementChild);
    });
}

let saveTimeout;
function autoSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        saveAllData();
    }, 500);
}

// ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–¢æ•°
function downloadBackup() {
    const data = {
        tasks: tasks,
        genres: genres,
        dailyProgress: dailyProgress,
        memos: memos,
        exportDate: new Date().toISOString(),
        version: '2.0'
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `dream-novel-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showNotification('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†', 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
}

function uploadBackup() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);
                tasks = data.tasks || {};
                genres = data.genres || ['TRICK', 'KILLERS'];
                dailyProgress = data.dailyProgress || {};
                memos = data.memos || [];
                saveAllData();
                saveMemos();
                rebuildGenreTabs();
                renderTasks();
                updateStats();
                updateProgressSection();
                displayMemos();
                showNotification('å¾©å…ƒå®Œäº†', 'ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ', 'success');
            } catch (e) {
                showNotification('ã‚¨ãƒ©ãƒ¼', 'ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

// ===== åˆæœŸåŒ–é–¢æ•° =====
function init() {
    loadTheme();
    const hasData = loadAllData();
    loadMemos();
    
    if (!hasData || Object.keys(tasks).length === 0) {
        const today = new Date().toISOString().split('T')[0];
        dailyProgress[today] = 0;
        generateInitialTasks();
    }
    
    rebuildGenreTabs();
    renderTasks();
    updateStats();
    updateAIAdvice();
    checkOverdueTasks();
    updateProgressSection();
    updateMotivation();
    updateTodayProgress();
    
    showWeeklyView();
    checkAchievements();
    displayMemos();
    initAnalysisDashboard();
    
    // è‡ªå‹•åŒæœŸè¨­å®šï¼ˆ5åˆ†ã”ã¨ï¼‰
    syncInterval = setInterval(() => {
        if (navigator.onLine) {
            saveToCloud();
        }
    }, 5 * 60 * 1000);
    
    // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–
    window.addEventListener('online', () => {
        updateSyncStatus('syncing');
        setTimeout(() => {
            saveToCloud();
        }, 1000);
    });
    
    window.addEventListener('offline', () => {
        updateSyncStatus('error');
    });
}

// åˆæœŸã‚¿ã‚¹ã‚¯ç”Ÿæˆ
function generateInitialTasks() {
    genres.forEach(genre => {
        tasks[genre] = generateTasksForGenre(genre);
    });
}

// ã‚¸ãƒ£ãƒ³ãƒ«ç”¨ã‚¿ã‚¹ã‚¯ç”Ÿæˆ
function generateTasksForGenre(genre) {
    const today = new Date();
    const taskTemplates = [
        {
            title: `${genre} ã‚»ãƒªãƒ•èµ·ã“ã—`,
            type: 'transcript',
            duration: 2,
            estimatedPomodoros: 8,
            priority: 'high',
            details: 'MakeMKV(1æ™‚é–“) â†’ HandBrake(1æ™‚é–“) â†’ Notta(1-2æ™‚é–“)',
            subTasks: [
                { name: 'MakeMKVå‡¦ç†', completed: false },
                { name: 'HandBrakeå¤‰æ›', completed: false },
                { name: 'Nottaæ–‡å­—èµ·ã“ã—', completed: false }
            ]
        },
        {
            title: `${genre} ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ†æ`,
            type: 'analysis',
            duration: 2,
            estimatedPomodoros: 4,
            priority: 'medium',
            details: 'ã‚»ãƒªãƒ•ã‹ã‚‰æ€§æ ¼ç‰¹æ€§ã‚’æŠ½å‡ºãƒ»åˆ†æ',
            subTasks: [
                { name: 'ä¸»è¦ã‚­ãƒ£ãƒ©ã®æ€§æ ¼åˆ†æ', completed: false },
                { name: 'é–¢ä¿‚æ€§ã®æ•´ç†', completed: false }
            ]
        },
        {
            title: `${genre} å±•é–‹ãƒ»ä¸–ç•Œè¦³åˆ†æ`,
            type: 'analysis',
            duration: 2,
            estimatedPomodoros: 4,
            priority: 'medium',
            details: 'ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æ§‹é€ ã¨ä¸–ç•Œè¦³ã®æŠŠæ¡',
            subTasks: [
                { name: 'ãƒ—ãƒ­ãƒƒãƒˆåˆ†æ', completed: false },
                { name: 'ä¸–ç•Œè¦³è¨­å®šã®æ•´ç†', completed: false }
            ]
        },
        {
            title: `${genre} ä¼ç·šå±•é–‹ãƒ•ã‚¡ã‚¤ãƒ«`,
            type: 'planning',
            duration: 3,
            estimatedPomodoros: 6,
            priority: 'high',
            details: '3-5ç« æ§‹æˆã®ä½œæˆ',
            subTasks: [
                { name: 'ç« æ§‹æˆã®æ±ºå®š', completed: false },
                { name: 'ä¼ç·šã®é…ç½®', completed: false },
                { name: 'ã‚¯ãƒ©ã‚¤ãƒãƒƒã‚¯ã‚¹ã®è¨­è¨ˆ', completed: false }
            ]
        },
        {
            title: `${genre} å¤¢å°èª¬åŸ·ç­†`,
            type: 'writing',
            duration: 10,
            estimatedPomodoros: 20,
            priority: 'high',
            details: 'å„ç« 3-5è©±ã€1è©±8000å­—ç›®å®‰ï¼ˆåˆè¨ˆ72,000å­—ï¼‰',
            subTasks: [
                { name: 'ç¬¬1ç« åŸ·ç­†', completed: false },
                { name: 'ç¬¬2ç« åŸ·ç­†', completed: false },
                { name: 'ç¬¬3ç« åŸ·ç­†', completed: false }
            ]
        }
    ];
    
    let currentDate = new Date(today);
    return taskTemplates.map((template, index) => {
        const task = {
            id: `${genre}-${Date.now()}-${index}`,
            genre: genre,
            ...template,
            startDate: currentDate.toISOString().split('T')[0],
            endDate: new Date(currentDate.getTime() + (template.duration - 1) * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
            progress: 0,
            pomodoroSessions: 0,
            completed: false
        };
        currentDate = new Date(currentDate.getTime() + template.duration * 24 * 60 * 60 * 1000);
        return task;
    });
}

// ã‚¿ã‚¹ã‚¯è¡¨ç¤º
function renderTasks() {
    const taskList = document.getElementById('taskList');
    taskList.innerHTML = '';
    
    Object.entries(tasks).forEach(([genre, genreTasks]) => {
        if (selectedGenre !== 'å…¨ä½“' && selectedGenre !== genre) return;
        
        const genreSection = document.createElement('div');
        genreSection.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
                <h3 style="color: white;">${genre}</h3>
                <button class="btn btn-success btn-small" onclick="showAddTaskModal('${genre}')">
                    + ã‚¿ã‚¹ã‚¯è¿½åŠ 
                </button>
            </div>
        `;
        
        genreTasks.forEach(task => {
            const taskCard = createTaskCard(task);
            genreSection.appendChild(taskCard);
        });
        
        taskList.appendChild(genreSection);
    });
}

// ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ä½œæˆ
function createTaskCard(task) {
    const card = document.createElement('div');
    const isOverdue = new Date(task.endDate) < new Date() && !task.completed;
    card.className = `task-card ${task.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}`;
    
    const deadlineClass = getDeadlineClass(task.endDate);
    const deadlineText = new Date(task.endDate).toLocaleDateString('ja-JP');
    
    card.innerHTML = `
        <div class="task-header">
            <div style="display: flex; align-items: center; flex: 1;">
                <input type="checkbox" class="checkbox" ${task.completed ? 'checked' : ''}
                    onchange="toggleTask('${task.id}')">
                <div class="task-title" onclick="showTaskDetail('${task.id}')">${task.title}</div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="task-deadline ${deadlineClass}">${deadlineText}</div>
                <div class="task-actions">
                    <button class="btn btn-danger btn-small" onclick="deleteTask('${task.id}')">å‰Šé™¤</button>
                </div>
            </div>
        </div>
        <div style="font-size: 12px; color: #666; margin: 5px 0;">${task.details}</div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: ${task.progress}%"></div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 12px;">ğŸ… ${task.pomodoroSessions}/${task.estimatedPomodoros}</span>
            <button class="btn btn-primary btn-small" onclick="startTaskPomodoro('${task.id}')">
                ${currentTaskId === task.id && pomodoroActive ? 'ä½œæ¥­ä¸­' : 'ä½œæ¥­é–‹å§‹'}
            </button>
        </div>
    `;
    
    return card;
}

// æœŸé™ã‚¯ãƒ©ã‚¹åˆ¤å®š
function getDeadlineClass(endDate) {
    const today = new Date();
    const deadline = new Date(endDate);
    const daysLeft = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
    
    if (daysLeft < 0) return 'deadline-overdue';
    if (daysLeft <= 2) return 'deadline-urgent';
    if (daysLeft <= 5) return 'deadline-soon';
    return 'deadline-normal';
}

// æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ãƒã‚§ãƒƒã‚¯
function checkOverdueTasks() {
    const overdueTasks = [];
    Object.values(tasks).forEach(genreTasks => {
        genreTasks.forEach(task => {
            if (new Date(task.endDate) < new Date() && !task.completed) {
                overdueTasks.push(task);
            }
        });
    });
    
    if (overdueTasks.length > 0) {
        document.getElementById('overdueAlert').style.display = 'block';
        document.getElementById('overdueList').innerHTML = overdueTasks.map(task =>
            `<div style="margin: 5px 0;">â€¢ ${task.title} (${new Date(task.endDate).toLocaleDateString('ja-JP')}æœŸé™)</div>`
        ).join('');
    } else {
        document.getElementById('overdueAlert').style.display = 'none';
    }
}

// æœŸé™å†è¨­å®š
function rescheduleOverdue() {
    const today = new Date();
    Object.keys(tasks).forEach(genre => {
        tasks[genre] = tasks[genre].map(task => {
            if (new Date(task.endDate) < today && !task.completed) {
                const duration = Math.ceil((new Date(task.endDate) - new Date(task.startDate)) / (1000 * 60 * 60 * 24));
                task.startDate = today.toISOString().split('T')[0];
                task.endDate = new Date(today.getTime() + duration * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            }
            return task;
        });
    });
    renderTasks();
    checkOverdueTasks();
    showNotification('æœŸé™å†è¨­å®š', 'æ–°ã—ã„æœŸé™ã§é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼', 'success');
    autoSave();
}

// ã‚¿ã‚¹ã‚¯è©³ç´°è¡¨ç¤º
function showTaskDetail(taskId) {
    let task = null;
    Object.values(tasks).forEach(genreTasks => {
        const found = genreTasks.find(t => t.id === taskId);
        if (found) task = found;
    });
    
    if (!task) return;
    
    currentDetailTask = task;
    document.getElementById('detailTitle').textContent = task.title;
    
    const content = document.getElementById('detailContent');
    content.innerHTML = `
        <div style="margin-bottom: 15px;">
            <strong>æœŸé–“:</strong> ${task.startDate} ã€œ ${task.endDate}<br>
            <strong>é€²æ—:</strong> ${Math.round(task.progress)}%<br>
            <strong>ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­:</strong> ${task.pomodoroSessions}/${task.estimatedPomodoros}
        </div>
        <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
            <strong>ä½œæ¥­è©³ç´°:</strong><br>
            ${task.details}
        </div>
        ${task.subTasks ? `
            <div>
                <strong>ã‚µãƒ–ã‚¿ã‚¹ã‚¯:</strong>
                ${task.subTasks.map((sub, idx) => `
                    <div class="subtask-item">
                        <input type="checkbox" class="subtask-checkbox"
                            ${sub.completed ? 'checked' : ''}
                            onchange="toggleSubtask('${task.id}', ${idx})">
                        <span>${sub.name}</span>
                    </div>
                `).join('')}
            </div>
        ` : ''}
    `;
    
    const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
    document.getElementById('motivationalQuote').textContent = `"${randomQuote}"`;
    
    document.getElementById('detailModal').style.display = 'flex';
}

// ã‚µãƒ–ã‚¿ã‚¹ã‚¯åˆ‡ã‚Šæ›¿ãˆ
function toggleSubtask(taskId, subIndex) {
    Object.keys(tasks).forEach(genre => {
        tasks[genre] = tasks[genre].map(task => {
            if (task.id === taskId && task.subTasks) {
                task.subTasks[subIndex].completed = !task.subTasks[subIndex].completed;
                const completedSubs = task.subTasks.filter(s => s.completed).length;
                task.progress = Math.max(task.progress, (completedSubs / task.subTasks.length) * 50);
            }
            return task;
        });
    });
    updateStats();
    autoSave();
}

// è©³ç´°ã‹ã‚‰ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­é–‹å§‹
function startDetailPomodoro() {
    if (currentDetailTask) {
        startTaskPomodoro(currentDetailTask.id);
        hideModal('detailModal');
    }
}

// ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function showAddTaskModal(genre) {
    currentEditGenre = genre;
    document.getElementById('taskModalTitle').textContent = `${genre} - ã‚¿ã‚¹ã‚¯è¿½åŠ `;
    document.getElementById('taskModal').style.display = 'flex';
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('taskStartDate').value = today;
    document.getElementById('taskEndDate').value = today;
}

// ã‚¿ã‚¹ã‚¯ä¿å­˜
function saveTask() {
    const task = {
        id: `${currentEditGenre}-${Date.now()}`,
        genre: currentEditGenre,
        title: document.getElementById('taskTitle').value,
        type: document.getElementById('taskType').value,
        startDate: document.getElementById('taskStartDate').value,
        endDate: document.getElementById('taskEndDate').value,
        estimatedPomodoros: parseInt(document.getElementById('taskPomodoros').value),
        priority: document.getElementById('taskPriority').value,
        details: document.getElementById('taskDetails').value,
        progress: 0,
        pomodoroSessions: 0,
        completed: false
    };
    
    tasks[currentEditGenre].push(task);
    renderTasks();
    updateStats();
    hideModal('taskModal');
    
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDetails').value = '';
    autoSave();
    showNotification('ã‚¿ã‚¹ã‚¯è¿½åŠ ', 'æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
}

// ã‚¿ã‚¹ã‚¯å‰Šé™¤
function deleteTask(taskId) {
    if (confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        Object.keys(tasks).forEach(genre => {
            tasks[genre] = tasks[genre].filter(task => task.id !== taskId);
        });
        renderTasks();
        updateStats();
        autoSave();
        showNotification('ã‚¿ã‚¹ã‚¯å‰Šé™¤', 'ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    }
}

// ã‚¿ã‚¹ã‚¯å®Œäº†åˆ‡ã‚Šæ›¿ãˆ
function toggleTask(taskId) {
    Object.keys(tasks).forEach(genre => {
        tasks[genre] = tasks[genre].map(task => {
            if (task.id === taskId) {
                task.completed = !task.completed;
                if (task.completed) {
                    task.progress = 100;
                    motivationLevel = Math.min(100, motivationLevel + 10);
                    updateMotivation();
                    showNotification('ãŠã‚ã§ã¨ã†ï¼', 'ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã—ã¾ã—ãŸï¼ğŸ‰', 'success');
                }
            }
            return task;
        });
    });
    renderTasks();
    updateStats();
    updateProgressSection();
    checkAchievements();
    autoSave();
}

// ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼
function togglePomodoro() {
    pomodoroActive = !pomodoroActive;
    if (pomodoroActive) {
        pomodoroInterval = setInterval(updatePomodoro, 1000);
    } else {
        clearInterval(pomodoroInterval);
    }
}

function updatePomodoro() {
    if (pomodoroTime > 0) {
        pomodoroTime--;
        const minutes = Math.floor(pomodoroTime / 60);
        const seconds = pomodoroTime % 60;
        document.getElementById('pomodoroTime').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
    } else {
        completePomodoro();
    }
}

function completePomodoro() {
    pomodoroActive = false;
    clearInterval(pomodoroInterval);
    pomodoroTime = 25 * 60;
    
    const today = new Date().toISOString().split('T')[0];
    dailyProgress[today] = (dailyProgress[today] || 0) + 1;
    
    if (currentTaskId) {
        Object.keys(tasks).forEach(genre => {
            tasks[genre] = tasks[genre].map(task => {
                if (task.id === currentTaskId) {
                    task.pomodoroSessions++;
                    task.progress = Math.min(100, (task.pomodoroSessions / task.estimatedPomodoros) * 100);
                }
                return task;
            });
        });
    }
    
    motivationLevel = Math.min(100, motivationLevel + 5);
    updateMotivation();
    updateTodayProgress();
    renderTasks();
    updateStats();
    updateProgressSection();
    checkAchievements();
    
    showNotification('ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­å®Œäº†ï¼', '5åˆ†ä¼‘æ†©ã—ã¦ãã ã•ã„ ğŸ‰', 'success');
    autoSave();
}

function startTaskPomodoro(taskId) {
    currentTaskId = taskId;
    if (!pomodoroActive) {
        togglePomodoro();
    }
}

// é€²æ—çŠ¶æ³æ›´æ–°
function updateProgressSection() {
    const activeTasks = [];
    Object.values(tasks).forEach(genreTasks => {
        genreTasks.forEach(task => {
            if (!task.completed && task.pomodoroSessions > 0) {
                activeTasks.push(task);
            }
        });
    });
    
    const focusElement = document.getElementById('currentFocus');
    if (activeTasks.length > 0) {
        const mostActive = activeTasks.sort((a, b) => b.pomodoroSessions - a.pomodoroSessions)[0];
        focusElement.innerHTML = `ğŸ”¥ ç¾åœ¨æ³¨åŠ›ä¸­: <strong>${mostActive.title}</strong> (${mostActive.pomodoroSessions}ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­å®Ÿæ–½)`;
    } else {
        focusElement.innerHTML = 'ğŸ“ ã¾ã ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã—ã¦ã„ã¾ã›ã‚“';
    }
    
    const progressBars = document.getElementById('genreProgressBars');
    progressBars.innerHTML = '';
    
    Object.entries(tasks).forEach(([genre, genreTasks]) => {
        const total = genreTasks.length;
        const completed = genreTasks.filter(t => t.completed).length;
        const percentage = total > 0 ? (completed / total * 100) : 0;
        
        progressBars.innerHTML += `
            <div class="genre-progress">
                <div style="display: flex; justify-content: space-between;">
                    <span>${genre}</span>
                    <span>${completed}/${total} å®Œäº†</span>
                </div>
                <div class="genre-progress-bar">
                    <div class="genre-progress-fill" style="width: ${percentage}%"></div>
                </div>
            </div>
        `;
    });
}

// ä»Šæ—¥ã®é€²æ—æ›´æ–°
function updateTodayProgress() {
    const today = new Date().toISOString().split('T')[0];
    const todayCount = dailyProgress[today] || 0;
    
    document.getElementById('todayCount').textContent = todayCount;
    
    const dots = document.querySelectorAll('.pomodoro-dot');
    dots.forEach((dot, index) => {
        if (index < todayCount) {
            dot.classList.add('filled');
        } else {
            dot.classList.remove('filled');
        }
    });
}

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º
function showCalendarModal() {
    const calendar = document.getElementById('calendarContent');
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    
    let html = '<div class="calendar">';
    
    const weekDays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
    weekDays.forEach(day => {
        html += `<div style="font-weight: bold; text-align: center; padding: 5px;">${day}</div>`;
    });
    
    for (let i = 0; i < firstDay.getDay(); i++) {
        html += '<div></div>';
    }
    
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = date.toISOString().split('T')[0];
        const pomodoros = dailyProgress[dateStr] || 0;
        const isToday = day === today.getDate();
        
        let emoji = '';
        if (pomodoros >= 8) emoji = 'ğŸ†';
        else if (pomodoros >= 4) emoji = 'â­';
        else if (pomodoros > 0) emoji = 'âœ“';
        
        html += `
            <div class="calendar-day ${isToday ? 'today' : ''}">
                <div class="calendar-day-number">${day}</div>
                ${emoji ? `<div>${emoji}</div>` : ''}
                ${pomodoros > 0 ? `<div class="calendar-day-pomodoros">${pomodoros}ğŸ…</div>` : ''}
            </div>
        `;
    }
    
    html += '</div>';
    calendar.innerHTML = html;
    document.getElementById('calendarModal').style.display = 'flex';
}

// ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
function updateMotivation() {
    document.getElementById('motivationBar').style.width = `${motivationLevel}%`;
    let text = '';
    if (motivationLevel >= 90) text = 'ğŸ”¥ çµ¶å¥½èª¿ï¼';
    else if (motivationLevel >= 70) text = 'â­ ã„ã„æ„Ÿã˜ï¼';
    else if (motivationLevel >= 50) text = 'ğŸ’– ãã®èª¿å­ï¼';
    else text = 'â˜• ä¼‘æ†©ã‚‚å¤§åˆ‡';
    document.getElementById('motivationText').textContent = `${text} ${motivationLevel}%`;
}

// çµ±è¨ˆæ›´æ–°
function updateStats() {
    let completed = 0;
    let pomodoros = 0;
    let words = 0;
    
    Object.values(tasks).forEach(genreTasks => {
        genreTasks.forEach(task => {
            if (task.completed) completed++;
            pomodoros += task.pomodoroSessions;
            if (task.type === 'writing') {
                words += Math.floor(task.progress * 720);
            }
        });
    });
    
    document.getElementById('completedCount').textContent = completed;
    document.getElementById('pomodoroCount').textContent = pomodoros;
    document.getElementById('wordCount').textContent = words.toLocaleString();
}

// AIã‚¢ãƒ‰ãƒã‚¤ã‚¹æ›´æ–°
function updateAIAdvice() {
    const allTasks = Object.values(tasks).flat().filter(t => !t.completed);
    const sortedTasks = allTasks.sort((a, b) => {
        const scoreA = calculatePriority(a);
        const scoreB = calculatePriority(b);
        return scoreB - scoreA;
    });
    
    const advice = document.getElementById('aiAdvice');
    if (sortedTasks.length > 0) {
        advice.innerHTML = sortedTasks.slice(0, 3).map((task, index) =>
            `<div style="padding: 5px 0;">
                <strong>#${index + 1}</strong> ${task.title}
                <span style="font-size: 12px; color: #666;">
                    (æœŸé™: ${new Date(task.endDate).toLocaleDateString('ja-JP')})
                </span>
            </div>`
        ).join('');
    } else {
        advice.innerHTML = 'ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ã¦ã„ã¾ã™ï¼ğŸ‰';
    }
}

function calculatePriority(task) {
    const today = new Date();
    const deadline = new Date(task.endDate);
    const daysLeft = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
    
    let score = 0;
    if (daysLeft < 0) score += 100;
    else if (daysLeft <= 2) score += 80;
    else if (daysLeft <= 5) score += 50;
    
    if (task.priority === 'high') score += 40;
    else if (task.priority === 'medium') score += 20;
    
    return score;
}

// ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠ
function selectGenre(genre) {
    selectedGenre = genre;
    document.querySelectorAll('.genre-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent === genre) {
            tab.classList.add('active');
        }
    });
    renderTasks();
}

// ã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«
function showAddGenreModal() {
    document.getElementById('genreModal').style.display = 'flex';
}

function hideModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function addGenre() {
    const input = document.getElementById('genreInput');
    const genreName = input.value.trim();
    
    if (genreName && !genres.includes(genreName)) {
        genres.push(genreName);
        tasks[genreName] = generateTasksForGenre(genreName);
        
        const tabsContainer = document.querySelector('.genre-tabs');
        const newTab = document.createElement('div');
        newTab.className = 'genre-tab';
        newTab.textContent = genreName;
        newTab.onclick = () => selectGenre(genreName);
        tabsContainer.insertBefore(newTab, tabsContainer.lastElementChild);
        
        renderTasks();
        updateStats();
        updateProgressSection();
        motivationLevel = Math.min(100, motivationLevel + 10);
        updateMotivation();
        showNotification('ã‚¸ãƒ£ãƒ³ãƒ«è¿½åŠ ', `${genreName}ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
    }
    
    input.value = '';
    hideModal('genreModal');
    autoSave();
}

// ===== ãƒ†ãƒ¼ãƒã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º =====
const themes = {
    default: { primary: '#667eea', secondary: '#764ba2', name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ', emoji: 'âœ¨' },
    sunset: { primary: '#f093fb', secondary: '#f5576c', name: 'ã‚µãƒ³ã‚»ãƒƒãƒˆ', emoji: 'ğŸŒ…' },
    ocean: { primary: '#89f7fe', secondary: '#66a6ff', name: 'ã‚ªãƒ¼ã‚·ãƒ£ãƒ³', emoji: 'ğŸŒŠ' },
    forest: { primary: '#43e97b', secondary: '#38f9d7', name: 'ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ', emoji: 'ğŸŒ²' },
    night: { primary: '#2c3e50', secondary: '#3498db', name: 'ãƒŠã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰', emoji: 'ğŸŒ™' },
    sakura: { primary: '#ffc0cb', secondary: '#ffb6c1', name: 'æ¡œ', emoji: 'ğŸŒ¸' }
};

function showThemeModal() {
    const container = document.getElementById('themeOptions');
    const currentTheme = localStorage.getItem('selectedTheme') || 'default';
    
    container.innerHTML = Object.entries(themes).map(([key, theme]) => `
        <div onclick="applyTheme('${key}')" style="
            background: linear-gradient(135deg, ${theme.primary} 0%, ${theme.secondary} 100%);
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            ${currentTheme === key ? 'border: 3px solid #333;' : ''}
        ">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 24px;">${theme.emoji}</span>
                <span style="font-weight: bold;">${theme.name}</span>
            </div>
            ${currentTheme === key ? '<span>âœ“ ä½¿ç”¨ä¸­</span>' : ''}
        </div>
    `).join('');
    
    document.getElementById('themeModal').style.display = 'flex';
}

function applyTheme(themeName) {
    const theme = themes[themeName];
    document.body.style.background = `linear-gradient(135deg, ${theme.primary} 0%, ${theme.secondary} 100%)`;
    
    const progressSection = document.querySelector('.progress-section');
    if (progressSection) {
        progressSection.style.background = `linear-gradient(135deg, ${theme.primary} 0%, ${theme.secondary} 100%)`;
    }
    
    localStorage.setItem('selectedTheme', themeName);
    hideModal('themeModal');
}

function loadTheme() {
    const savedTheme = localStorage.getItem('selectedTheme');
    if (savedTheme && themes[savedTheme]) {
        applyTheme(savedTheme);
    }
}

// ===== è©³ç´°åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ =====
function showAnalysisTab(tabName) {
    document.querySelectorAll('.analysis-tab').forEach(tab => {
        tab.style.background = '#e0e0e0';
        tab.style.color = '#333';
        tab.classList.remove('active');
    });
    event.target.style.background = '#667eea';
    event.target.style.color = 'white';
    event.target.classList.add('active');
    
    const content = document.getElementById('analysisContent');
    
    switch(tabName) {
        case 'patterns':
            showWorkPatterns(content);
            break;
        case 'productivity':
            showProductivityAnalysis(content);
            break;
        case 'comparison':
            showGenreComparison(content);
            break;
    }
}

function showWorkPatterns(container) {
    const last30Days = {};
    const today = new Date();
    
    for (let i = 0; i < 30; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        last30Days[dateStr] = dailyProgress[dateStr] || 0;
    }
    
    const weekdayStats = { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] };
    Object.entries(last30Days).forEach(([dateStr, count]) => {
        const day = new Date(dateStr).getDay();
        weekdayStats[day].push(count);
    });
    
    const weekdayAverage = Object.entries(weekdayStats).map(([day, counts]) => {
        const avg = counts.length > 0 ? counts.reduce((a, b) => a + b, 0) / counts.length : 0;
        return { day: parseInt(day), average: avg };
    });
    
    const weekDays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
    const maxAvg = Math.max(...weekdayAverage.map(d => d.average));
    
    container.innerHTML = `
        <div>
            <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ“… æ›œæ—¥åˆ¥å¹³å‡ä½œæ¥­é‡</h4>
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px;">
                ${weekdayAverage.map(data => `
                    <div style="text-align: center;">
                        <div style="font-weight: bold; margin-bottom: 5px; color: ${data.day === 0 ? '#ff6b6b' : data.day === 6 ? '#4169e1' : '#333'};">
                            ${weekDays[data.day]}
                        </div>
                        <div style="background: #e0e0e0; height: 100px; position: relative; border-radius: 5px;">
                            <div style="
                                position: absolute;
                                bottom: 0;
                                width: 100%;
                                height: ${maxAvg > 0 ? (data.average / maxAvg * 100) : 0}%;
                                background: linear-gradient(to top, #667eea, #764ba2);
                                border-radius: 5px;
                            "></div>
                        </div>
                        <div style="margin-top: 5px; font-size: 12px; color: #666;">
                            å¹³å‡ ${data.average.toFixed(1)}ğŸ…
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function showProductivityAnalysis(container) {
    const typeStats = {};
    Object.values(tasks).forEach(genreTasks => {
        genreTasks.forEach(task => {
            if (!typeStats[task.type]) {
                typeStats[task.type] = { total: 0, completed: 0 };
            }
            typeStats[task.type].total++;
            if (task.completed) typeStats[task.type].completed++;
        });
    });
    
    const typeNames = {
        transcript: 'ã‚»ãƒªãƒ•èµ·ã“ã—',
        analysis: 'åˆ†æ',
        planning: 'æ§‹æˆãƒ»ä¼ç”»',
        writing: 'åŸ·ç­†',
        other: 'ãã®ä»–'
    };
    
    container.innerHTML = `
        <div>
            <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ¯ ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—åˆ¥å®Œäº†ç‡</h4>
            <div style="display: grid; gap: 10px;">
                ${Object.entries(typeStats).map(([type, stats]) => {
                    const rate = stats.total > 0 ? (stats.completed / stats.total * 100) : 0;
                    return `
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-weight: bold;">${typeNames[type] || type}</span>
                                <span style="color: #667eea;">${stats.completed}/${stats.total} (${rate.toFixed(0)}%)</span>
                            </div>
                            <div style="background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="
                                    width: ${rate}%;
                                    height: 100%;
                                    background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
                                    transition: width 0.3s ease;
                                "></div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

function showGenreComparison(container) {
    const genreStats = {};
    
    Object.entries(tasks).forEach(([genre, genreTasks]) => {
        const completed = genreTasks.filter(t => t.completed).length;
        const total = genreTasks.length;
        const totalPomodoros = genreTasks.reduce((sum, t) => sum + t.pomodoroSessions, 0);
        const avgProgress = genreTasks.reduce((sum, t) => sum + t.progress, 0) / (total || 1);
        
        genreStats[genre] = {
            completed,
            total,
            completionRate: total > 0 ? (completed / total * 100) : 0,
            totalPomodoros,
            avgProgress
        };
    });
    
    container.innerHTML = `
        <div>
            <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ“Š ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥é€²æ—æ¯”è¼ƒ</h4>
            <div style="display: grid; gap: 15px;">
                ${Object.entries(genreStats).map(([genre, stats]) => `
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 10px;">
                        <h5 style="color: #333; margin-bottom: 10px;">${genre}</h5>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <div>
                                <div style="font-size: 12px; color: #666;">å®Œäº†ç‡</div>
                                <div style="font-size: 24px; color: #667eea; font-weight: bold;">
                                    ${stats.completionRate.toFixed(0)}%
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">ç·ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­</div>
                                <div style="font-size: 24px; color: #f5576c; font-weight: bold;">
                                    ${stats.totalPomodoros}ğŸ…
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function initAnalysisDashboard() {
    const content = document.getElementById('analysisContent');
    if (content) {
        showWorkPatterns(content);
    }
}

// ===== é€±é–“ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ =====
function showWeeklyView() {
    const today = new Date();
    const weekStart = new Date(today);
    weekStart.setDate(today.getDate() - today.getDay());
    
    let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px;">';
    const weekDays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
    
    for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart);
        date.setDate(weekStart.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        const isToday = date.toDateString() === today.toDateString();
        
        const dayTasks = [];
        Object.values(tasks).forEach(genreTasks => {
            genreTasks.forEach(task => {
                if (!task.completed && 
                    new Date(task.startDate) <= date && 
                    new Date(task.endDate) >= date) {
                    dayTasks.push(task);
                }
            });
        });
        
        html += `
            <div style="background: white; border-radius: 8px; padding: 8px; ${isToday ? 'border: 2px solid #667eea;' : ''}">
                <div style="font-weight: bold; text-align: center; color: ${i === 0 ? '#ff6b6b' : i === 6 ? '#4169e1' : '#333'};">
                    ${weekDays[i]}
                </div>
                <div style="font-size: 12px; text-align: center; margin: 5px 0;">
                    ${date.getMonth() + 1}/${date.getDate()}
                </div>
                <div style="font-size: 10px; color: #666;">
                    ${dayTasks.slice(0, 3).map(t => `â€¢ ${t.title.substring(0, 8)}...`).join('<br>')}
                    ${dayTasks.length > 3 ? `<br>ä»–${dayTasks.length - 3}ä»¶` : ''}
                </div>
                ${dayTasks.length > 0 ? `<div style="text-align: center; font-size: 12px; color: #667eea; margin-top: 5px;">${dayTasks.length}ä»¶</div>` : ''}
            </div>
        `;
    }
    
    html += '</div>';
    document.getElementById('weeklySchedule').innerHTML = html;
}

// ===== å®Ÿç¸¾ãƒãƒƒã‚¸æ©Ÿèƒ½ =====
const achievements = {
    firstTask: { icon: 'ğŸ¯', name: 'åˆã‚ã¦ã®ä¸€æ­©', condition: 'ã‚¿ã‚¹ã‚¯ã‚’1ã¤å®Œäº†' },
    fivePomodoros: { icon: 'ğŸ…', name: 'ãƒˆãƒãƒˆè¾²å®¶', condition: '5ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­é”æˆ' },
    tenPomodoros: { icon: 'ğŸŒŸ', name: 'ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ãƒã‚¹ã‚¿ãƒ¼', condition: '10ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­é”æˆ' },
    weekStreak: { icon: 'ğŸ”¥', name: 'ç¶™ç¶šã®é¬¼', condition: '7æ—¥é€£ç¶šä½œæ¥­' },
    genreMaster: { icon: 'ğŸ‘‘', name: 'ã‚¸ãƒ£ãƒ³ãƒ«åˆ¶è¦‡', condition: '1ã‚¸ãƒ£ãƒ³ãƒ«å…¨ã‚¿ã‚¹ã‚¯å®Œäº†' },
    earlyBird: { icon: 'ğŸŒ…', name: 'æ—©èµ·ãä½œå®¶', condition: 'æœ6æ™‚å‰ã«ä½œæ¥­é–‹å§‹' },
    nightOwl: { icon: 'ğŸ¦‰', name: 'å¤œå‹ä½œå®¶', condition: 'æ·±å¤œ0æ™‚ä»¥é™ã«ä½œæ¥­' },
    speedWriter: { icon: 'âš¡', name: 'ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ©ã‚¤ã‚¿ãƒ¼', condition: '1æ—¥ã§10000å­—åŸ·ç­†' },
    memoMaster: { icon: 'ğŸ“', name: 'ãƒ¡ãƒ¢ã®é”äºº', condition: '50å€‹ã®ãƒ¡ãƒ¢ã‚’ä½œæˆ' }
};

function checkAchievements() {
    const earned = JSON.parse(localStorage.getItem('achievements') || '[]');
    let completedTasks = 0;
    let totalPomodoros = 0;
    
    Object.values(tasks).forEach(genreTasks => {
        genreTasks.forEach(task => {
            if (task.completed) completedTasks++;
            totalPomodoros += task.pomodoroSessions;
        });
    });
    
    if (completedTasks >= 1 && !earned.includes('firstTask')) {
        earned.push('firstTask');
        showAchievementNotification(achievements.firstTask);
    }
    
    if (totalPomodoros >= 5 && !earned.includes('fivePomodoros')) {
        earned.push('fivePomodoros');
        showAchievementNotification(achievements.fivePomodoros);
    }
    
    if (totalPomodoros >= 10 && !earned.includes('tenPomodoros')) {
        earned.push('tenPomodoros');
        showAchievementNotification(achievements.tenPomodoros);
    }
    
    if (memos.length >= 50 && !earned.includes('memoMaster')) {
        earned.push('memoMaster');
        showAchievementNotification(achievements.memoMaster);
    }
    
    localStorage.setItem('achievements', JSON.stringify(earned));
    displayAchievements(earned);
}

function displayAchievements(earned) {
    const container = document.getElementById('achievementBadges');
    if (!container) return;
    
    container.innerHTML = earned.map(key => {
        const achievement = achievements[key];
        if (!achievement) return '';
        return `
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px; border-radius: 8px; text-align: center; min-width: 80px;">
                <div style="font-size: 24px;">${achievement.icon}</div>
                <div style="font-size: 10px; margin-top: 5px;">${achievement.name}</div>
            </div>
        `;
    }).join('');
}

function showAchievementNotification(achievement) {
    const notification = document.createElement('div');
    notification.className = 'notification success';
    notification.innerHTML = `
        <div style="font-size: 18px; margin-bottom: 5px;">ğŸ‰ å®Ÿç¸¾è§£é™¤ï¼</div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">${achievement.icon}</span>
            <div>
                <div style="font-weight: bold;">${achievement.name}</div>
                <div style="font-size: 12px;">${achievement.condition}</div>
            </div>
        </div>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.5s ease';
        setTimeout(() => notification.remove(), 500);
    }, 3000);
}

// ===== åˆæœŸåŒ–å®Ÿè¡Œ =====
window.addEventListener('DOMContentLoaded', () => {
    init();
});

// è‡ªå‹•ä¿å­˜è¨­å®š
window.addEventListener('beforeunload', () => {
    saveAllData();
});

// å®šæœŸçš„ãªè‡ªå‹•ä¿å­˜ï¼ˆ1åˆ†ã”ã¨ï¼‰
setInterval(() => {
    saveAllData();
}, 60000);
</script>

</body>
</html>
