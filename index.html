<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Â§¢Â∞èË™¨Ââµ‰Ωú„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</title>

<!-- PWAÂØæÂøú -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Â§¢Â∞èË™¨">

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 10px;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
}

.header {
    background: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.title {
    font-size: 24px;
    color: #333;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.motivation-bar {
    width: 200px;
    height: 20px;
    background: #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}

.motivation-fill {
    height: 100%;
    background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
    transition: width 0.3s ease;
}

.pomodoro-timer {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: #ffe0f0;
    padding: 10px 20px;
    border-radius: 25px;
    font-size: 20px;
    font-weight: bold;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5a67d8;
    transform: translateY(-2px);
}

.btn-success {
    background: #48bb78;
    color: white;
}

.btn-danger {
    background: #f56565;
    color: white;
}

.btn-warning {
    background: #ed8936;
    color: white;
}

.genre-tabs {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    flex-wrap: wrap;
}

.genre-tab {
    padding: 8px 16px;
    background: #f0f0f0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.genre-tab.active {
    background: #667eea;
    color: white;
}

.task-card {
    background: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
    position: relative;
}

.task-card.overdue {
    border-left: 5px solid #ff4444;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 4px 15px rgba(255,0,0,0.1); }
    50% { box-shadow: 0 4px 25px rgba(255,0,0,0.3); }
    100% { box-shadow: 0 4px 15px rgba(255,0,0,0.1); }
}

.task-card:hover {
    transform: translateY(-3px);
}

.task-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.task-title {
    font-weight: bold;
    font-size: 16px;
    color: #333;
    cursor: pointer;
}

.task-deadline {
    padding: 4px 8px;
    border-radius: 5px;
    color: white;
    font-size: 12px;
}

.deadline-overdue {
    background: #ff4444;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 50%, 100% { opacity: 1; }
    25%, 75% { opacity: 0.7; }
}

.deadline-urgent {
    background: #f56565;
}

.deadline-soon {
    background: #ed8936;
}

.deadline-normal {
    background: #48bb78;
}

.progress-bar {
    width: 100%;
    height: 10px;
    background: #e0e0e0;
    border-radius: 5px;
    overflow: hidden;
    margin: 10px 0;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transition: width 0.3s ease;
}

.ai-advice {
    background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    border-left: 4px solid #fdcb6e;
}

.overdue-alert {
    background: linear-gradient(135deg, #ff6b6b 0%, #ff4444 100%);
    color: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    animation: shake 0.5s;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.stat-card {
    background: white;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.stat-number {
    font-size: 24px;
    font-weight: bold;
    color: #667eea;
}

.stat-label {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: 15px;
    padding: 25px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.checkbox {
    width: 20px;
    height: 20px;
    margin-right: 10px;
    cursor: pointer;
}

.completed {
    text-decoration: line-through;
    opacity: 0.6;
}

.today-progress {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
}

.pomodoro-dots {
    display: flex;
    gap: 5px;
    margin: 10px 0;
}

.pomodoro-dot {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background: #e0e0e0;
}

.pomodoro-dot.filled {
    background: #ff6b6b;
}

.calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    padding: 10px;
    background: white;
    border-radius: 10px;
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 1px solid #e0e0e0;
    border-radius: 5px;
    font-size: 12px;
    position: relative;
}

.calendar-day.today {
    background: #e6f3ff;
    border-color: #667eea;
}

.calendar-day-number {
    font-weight: bold;
}

.calendar-day-pomodoros {
    font-size: 10px;
    color: #667eea;
}

.subtask-item {
    padding: 5px 0;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.subtask-checkbox {
    width: 16px;
    height: 16px;
}

.quote-box {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    padding: 15px;
    border-radius: 10px;
    margin-top: 15px;
    font-style: italic;
    text-align: center;
}

.task-actions {
    display: flex;
    gap: 5px;
    margin-left: auto;
}

.btn-small {
    padding: 4px 8px;
    font-size: 12px;
}

.progress-section {
    background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    color: white;
}

.genre-progress {
    margin: 10px 0;
}

.genre-progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(255,255,255,0.3);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 5px;
}

.genre-progress-fill {
    height: 100%;
    background: white;
    transition: width 0.3s ease;
}

input[type="text"], input[type="date"], input[type="number"], select, textarea {
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border: 1px solid #ddd;
    border-radius: 5px;
}

@media (max-width: 768px) {
    .title {
        font-size: 20px;
    }
    
    .pomodoro-timer {
        font-size: 16px;
        padding: 8px 15px;
    }
    
    .stats-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .modal-content {
        padding: 15px;
    }
}
</style>
</head>
<body>
<div class="container">
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div class="header">
        <div class="title">
            <span>‚ú®</span>
            <span>Â§¢Â∞èË™¨Ââµ‰Ωú„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</span>
        </div>
        
        <!-- „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éú„Çø„É≥ -->
        <div style="margin-top: 10px;">
            <button class="btn btn-warning btn-small" onclick="downloadBackup()">
                üíæ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
            </button>
            <button class="btn btn-success btn-small" onclick="uploadBackup()">
                üìÇ Âæ©ÂÖÉ
            </button>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <div>
                <div style="font-size: 14px; color: #666;">„É¢„ÉÅ„Éô„Éº„Ç∑„Éß„É≥</div>
                <div class="motivation-bar">
                    <div class="motivation-fill" id="motivationBar" style="width: 75%;"></div>
                </div>
                <div id="motivationText" style="font-size: 12px; color: #888;">„ÅÑ„ÅÑÊÑü„ÅòÔºÅ 75%</div>
            </div>
            
            <div class="pomodoro-timer">
                <span>üçÖ</span>
                <span id="pomodoroTime">25:00</span>
                <button class="btn btn-primary" onclick="togglePomodoro()">ÈñãÂßã</button>
            </div>
        </div>
        
        <div class="genre-tabs">
            <div class="genre-tab active" onclick="selectGenre('ÂÖ®‰Ωì')">ÂÖ®‰Ωì</div>
            <div class="genre-tab" onclick="selectGenre('TRICK')">TRICK</div>
            <div class="genre-tab" onclick="selectGenre('KILLERS')">KILLERS</div>
            <button class="btn btn-success" onclick="showAddGenreModal()">+ „Ç∏„É£„É≥„É´ËøΩÂä†</button>
        </div>
    </div>
    
    <!-- ÊúüÈôêÂàá„Çå„Ç¢„É©„Éº„Éà -->
    <div id="overdueAlert" style="display: none;" class="overdue-alert">
        <h3>‚ö†Ô∏è ÊúüÈôê„ÇíÈÅé„Åé„Åü„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„ÅôÔºÅ</h3>
        <div id="overdueList"></div>
        <button class="btn" style="background: white; color: #ff4444; margin-top: 10px;" onclick="rescheduleOverdue()">
            ÊúüÈôê„ÇíÂÜçË®≠ÂÆö„Åô„Çã
        </button>
    </div>
    
    <!-- ÈÄ≤ÊçóÁä∂Ê≥Å -->
    <div class="progress-section">
        <h3>üìä ÁèæÂú®„ÅÆÈÄ≤ÊçóÁä∂Ê≥Å</h3>
        <div id="currentFocus" style="margin: 10px 0; font-size: 14px;"></div>
        <div id="genreProgressBars"></div>
    </div>
    
    <!-- ‰ªäÊó•„ÅÆÈÄ≤Êçó -->
    <div class="today-progress">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3>üìä ‰ªäÊó•„ÅÆÈÅîÊàêÂ∫¶</h3>
                <div class="pomodoro-dots" id="todayProgress">
                    <div class="pomodoro-dot"></div>
                    <div class="pomodoro-dot"></div>
                    <div class="pomodoro-dot"></div>
                    <div class="pomodoro-dot"></div>
                    <div class="pomodoro-dot"></div>
                    <div class="pomodoro-dot"></div>
                    <div class="pomodoro-dot"></div>
                    <div class="pomodoro-dot"></div>
                </div>
                <div style="font-size: 14px; color: #666;">
                    <span id="todayCount">0</span>/8 „Éù„É¢„Éâ„Éº„É≠ÂÆå‰∫Ü
                </div>
            </div>
            <button class="btn btn-primary" onclick="showCalendarModal()">
                üìÖ „Ç´„É¨„É≥„ÉÄ„ÉºË°®Á§∫
            </button>
        </div>
    </div>
    
    <!-- AI„Ç¢„Éâ„Éê„Ç§„Çπ -->
    <div class="ai-advice">
        <h3 style="margin-bottom: 10px;">ü§ñ AIÊé®Â•®: ÂÑ™ÂÖà„Çø„Çπ„ÇØ</h3>
        <div id="aiAdvice">
            ÂàÜÊûê‰∏≠...
        </div>
    </div>
    
    <!-- „Çø„Çπ„ÇØ„É™„Çπ„Éà -->
    <div id="taskList"></div>
    
    <!-- Áµ±Ë®à -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="completedCount">0</div>
            <div class="stat-label">ÂÆå‰∫Ü„Çø„Çπ„ÇØ</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="pomodoroCount">0</div>
            <div class="stat-label">Á∑è„Éù„É¢„Éâ„Éº„É≠</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="wordCount">0</div>
            <div class="stat-label">Âü∑Á≠ÜÊñáÂ≠óÊï∞</div>
        </div>
    </div>
</div>

<!-- „Ç∏„É£„É≥„É´ËøΩÂä†„É¢„Éº„ÉÄ„É´ -->
<div id="genreModal" class="modal">
    <div class="modal-content">
        <h3>Êñ∞Ë¶è„Ç∏„É£„É≥„É´ËøΩÂä†</h3>
        <input type="text" id="genreInput" placeholder="„Ç∏„É£„É≥„É´Âêç„ÇíÂÖ•Âäõ">
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn btn-primary" onclick="addGenre()" style="flex: 1;">ËøΩÂä†</button>
            <button class="btn" onclick="hideModal('genreModal')" style="flex: 1; background: #ccc;">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
    </div>
</div>

<!-- „Çø„Çπ„ÇØËøΩÂä†„É¢„Éº„ÉÄ„É´ -->
<div id="taskModal" class="modal">
    <div class="modal-content">
        <h3 id="taskModalTitle">„Çø„Çπ„ÇØËøΩÂä†</h3>
        <input type="text" id="taskTitle" placeholder="„Çø„Çπ„ÇØÂêç">
        <select id="taskType">
            <option value="transcript">„Çª„É™„ÉïËµ∑„Åì„Åó</option>
            <option value="analysis">ÂàÜÊûê</option>
            <option value="planning">ÊßãÊàê„Éª‰ºÅÁîª</option>
            <option value="writing">Âü∑Á≠Ü</option>
            <option value="other">„Åù„ÅÆ‰ªñ</option>
        </select>
        <input type="date" id="taskStartDate">
        <input type="date" id="taskEndDate">
        <input type="number" id="taskPomodoros" placeholder="‰∫àÂÆö„Éù„É¢„Éâ„Éº„É≠Êï∞" min="1" value="4">
        <select id="taskPriority">
            <option value="high">ÂÑ™ÂÖàÂ∫¶: È´ò</option>
            <option value="medium">ÂÑ™ÂÖàÂ∫¶: ‰∏≠</option>
            <option value="low">ÂÑ™ÂÖàÂ∫¶: ‰Ωé</option>
        </select>
        <textarea id="taskDetails" placeholder="‰ΩúÊ•≠Ë©≥Á¥∞" rows="3"></textarea>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn btn-primary" onclick="saveTask()" style="flex: 1;">‰øùÂ≠ò</button>
            <button class="btn" onclick="hideModal('taskModal')" style="flex: 1; background: #ccc;">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
    </div>
</div>

<!-- „Çø„Çπ„ÇØË©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <h3 id="detailTitle">„Çø„Çπ„ÇØË©≥Á¥∞</h3>
        <div id="detailContent"></div>
        <div class="quote-box" id="motivationalQuote"></div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn btn-primary" onclick="startDetailPomodoro()" style="flex: 1;">‰ΩúÊ•≠ÈñãÂßã</button>
            <button class="btn" onclick="hideModal('detailModal')" style="flex: 1; background: #ccc;">Èñâ„Åò„Çã</button>
        </div>
    </div>
</div>

<!-- „Ç´„É¨„É≥„ÉÄ„Éº„É¢„Éº„ÉÄ„É´ -->
<div id="calendarModal" class="modal">
    <div class="modal-content">
        <h3>üìÖ ÊúàÈñì„Ç´„É¨„É≥„ÉÄ„Éº</h3>
        <div id="calendarContent"></div>
        <div style="margin-top: 15px;">
            <button class="btn" onclick="hideModal('calendarModal')" style="width: 100%; background: #ccc;">Èñâ„Åò„Çã</button>
        </div>
    </div>
</div>

<!-- „Åì„Åì„Åã„Çâ JavaScript „ÇíËøΩÂä† -->
<script>
// „Éë„Éº„Éà3„ÅÆJavaScript„Ç≥„Éº„Éâ„Çí„Åì„Åì„Å´ÈÖçÁΩÆ
</script>
<script>
// ===== „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ÂÆöÁæ© =====
let tasks = {};
let genres = ['TRICK', 'KILLERS'];
let selectedGenre = 'ÂÖ®‰Ωì';
let pomodoroActive = false;
let pomodoroTime = 25 * 60;
let motivationLevel = 75;
let pomodoroInterval;
let currentTaskId = null;
let currentEditGenre = null;
let currentDetailTask = null;
let dailyProgress = {};

const STORAGE_KEY = 'dreamNovelData';

// Âä±„Åæ„Åó„ÅÆË®ÄËëâ
const quotes = [
    "‰∏ÄÊ≠©„Åö„Å§ÈÄ≤„ÇÅ„Å∞„ÄÅÂøÖ„ÅöÁõÆÊ®ô„Å´Âà∞ÈÅî„Åß„Åç„Åæ„ÅôÔºÅ",
    "‰ªäÊó•„ÅÆÂ∞è„Åï„Å™Âä™Âäõ„Åå„ÄÅÊòéÊó•„ÅÆÂ§ß„Åç„Å™ÊàêÊûú„Å´„Å™„Çä„Åæ„Åô„ÄÇ",
    "Ââµ‰Ωú„ÅØÈ≠Ç„ÅÆË°®Áèæ„ÄÇ„ÅÇ„Å™„Åü„ÅÆÁâ©Ë™û„Çí‰∏ñÁïå„ÅåÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ",
    "ÂÆåÁíß„Åò„ÇÉ„Å™„Åè„Å¶„ÅÑ„ÅÑ„ÄÇ„Åæ„ÅöÂßã„ÇÅ„Çã„Åì„Å®„ÅåÂ§ßÂàá„Åß„Åô„ÄÇ",
    "„ÅÇ„Å™„Åü„ÅÆÊÉ≥ÂÉèÂäõ„ÅØÁÑ°ÈôêÂ§ß„ÄÇ‰ªäÊó•„ÇÇÁ¥†Êïµ„Å™Áâ©Ë™û„ÇíÁ¥°„Åé„Åæ„Åó„Çá„ÅÜ„ÄÇ",
    "‰ºëÊÜ©„ÇÇÂâµ‰Ωú„ÅÆ‰∏ÄÈÉ®„ÄÇ„É™„Éï„É¨„ÉÉ„Ç∑„É•„Åó„Å¶„ÄÅ„Åæ„ÅüÈ†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜÔºÅ",
    "„Å©„Çì„Å™ÂÅâÂ§ß„Å™‰ΩúÂÆ∂„ÇÇ„ÄÅ‰∏ÄÊñáÂ≠ó„Åã„ÇâÂßã„ÇÅ„Åæ„Åó„Åü„ÄÇ",
    "‰ªäÊõ∏„ÅÑ„Å¶„ÅÑ„Çã„Åù„ÅÆ‰∏ÄË°å„Åå„ÄÅË™∞„Åã„ÅÆÂøÉ„ÇíÂãï„Åã„Åô„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÇ",
    "Áñ≤„Çå„Åü„Å®„Åç„ÅØ„ÄÅ„Å™„ÅúÂßã„ÇÅ„Åü„ÅÆ„ÅãÊÄù„ÅÑÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
    "„ÅÇ„Å™„Åü„Å´„Åó„ÅãÊõ∏„Åë„Å™„ÅÑÁâ©Ë™û„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇËá™‰ø°„ÇíÊåÅ„Å£„Å¶ÔºÅ"
];

// ===== „Éá„Éº„ÇøÊ∞∏Á∂öÂåñÈñ¢Êï∞ =====
function saveAllData() {
    const dataToSave = {
        tasks: tasks,
        genres: genres,
        dailyProgress: dailyProgress,
        selectedGenre: selectedGenre,
        motivationLevel: motivationLevel,
        lastSaved: new Date().toISOString()
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
    console.log('„Éá„Éº„Çø‰øùÂ≠òÂÆå‰∫Ü:', new Date().toLocaleTimeString());
}

function loadAllData() {
    const savedData = localStorage.getItem(STORAGE_KEY);
    if (savedData) {
        try {
            const data = JSON.parse(savedData);
            tasks = data.tasks || {};
            genres = data.genres || ['TRICK', 'KILLERS'];
            dailyProgress = data.dailyProgress || {};
            selectedGenre = data.selectedGenre || 'ÂÖ®‰Ωì';
            motivationLevel = data.motivationLevel || 75;
            
            validateData();
            console.log('„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', data.lastSaved);
            return true;
        } catch (e) {
            console.error('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
            return false;
        }
    }
    return false;
}

function validateData() {
    // tasks„Å´Â≠òÂú®„Åô„Çã„Ç∏„É£„É≥„É´„Åågenres„Å´„ÇÇÂ≠òÂú®„Åô„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
    Object.keys(tasks).forEach(genre => {
        if (!genres.includes(genre)) {
            console.log(`„Ç∏„É£„É≥„É´„Äå${genre}„Äç„ÇíÂæ©ÂÖÉ`);
            genres.push(genre);
        }
    });
    
    // Á©∫„ÅÆ„Ç∏„É£„É≥„É´Ôºà„Çø„Çπ„ÇØ„Åå„Å™„ÅÑÔºâ„Åß„ÇÇ‰øùÊåÅ
    genres.forEach(genre => {
        if (!tasks[genre]) {
            tasks[genre] = [];
        }
    });
}

function rebuildGenreTabs() {
    const tabsContainer = document.querySelector('.genre-tabs');
    if (!tabsContainer) return;
    
    // Êó¢Â≠ò„ÅÆ„Çø„Éñ„Çí„ÇØ„É™„Ç¢Ôºà„Éú„Çø„É≥‰ª•Â§ñÔºâ
    const existingTabs = tabsContainer.querySelectorAll('.genre-tab');
    existingTabs.forEach(tab => tab.remove());
    
    // ÂÖ®‰Ωì„Çø„Éñ„ÇíËøΩÂä†
    const allTab = document.createElement('div');
    allTab.className = selectedGenre === 'ÂÖ®‰Ωì' ? 'genre-tab active' : 'genre-tab';
    allTab.textContent = 'ÂÖ®‰Ωì';
    allTab.onclick = () => selectGenre('ÂÖ®‰Ωì');
    tabsContainer.insertBefore(allTab, tabsContainer.firstChild);
    
    // ÂêÑ„Ç∏„É£„É≥„É´„ÅÆ„Çø„Éñ„ÇíËøΩÂä†
    genres.forEach(genre => {
        const tab = document.createElement('div');
        tab.className = selectedGenre === genre ? 'genre-tab active' : 'genre-tab';
        tab.textContent = genre;
        tab.onclick = () => selectGenre(genre);
        tabsContainer.insertBefore(tab, tabsContainer.lastElementChild);
    });
}

let saveTimeout;
function autoSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        saveAllData();
    }, 500);
}

// „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÈñ¢Êï∞
function downloadBackup() {
    const data = {
        tasks: tasks,
        genres: genres,
        dailyProgress: dailyProgress,
        exportDate: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `dream-novel-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    alert('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü');
}

function uploadBackup() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);
                tasks = data.tasks || {};
                genres = data.genres || ['TRICK', 'KILLERS'];
                dailyProgress = data.dailyProgress || {};
                saveAllData();
                rebuildGenreTabs();
                renderTasks();
                updateStats();
                updateProgressSection();
                alert('Âæ©ÂÖÉÂÆå‰∫ÜÔºÅ');
            } catch (e) {
                alert('„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

// ===== ÂàùÊúüÂåñÈñ¢Êï∞ =====
function init() {
    const hasData = loadAllData();
    
    if (!hasData || Object.keys(tasks).length === 0) {
        const today = new Date().toISOString().split('T')[0];
        dailyProgress[today] = 0;
        generateInitialTasks();
    }
    
    rebuildGenreTabs();
    renderTasks();
    updateStats();
    updateAIAdvice();
    checkOverdueTasks();
    updateProgressSection();
    updateMotivation();
    updateTodayProgress();
}

// ÂàùÊúü„Çø„Çπ„ÇØÁîüÊàê
function generateInitialTasks() {
    genres.forEach(genre => {
        tasks[genre] = generateTasksForGenre(genre);
    });
}

// „Ç∏„É£„É≥„É´Áî®„Çø„Çπ„ÇØÁîüÊàê
function generateTasksForGenre(genre) {
    const today = new Date();
    const taskTemplates = [
        {
            title: `${genre} „Çª„É™„ÉïËµ∑„Åì„Åó`,
            type: 'transcript',
            duration: 2,
            estimatedPomodoros: 8,
            priority: 'high',
            details: 'MakeMKV(1ÊôÇÈñì) ‚Üí HandBrake(1ÊôÇÈñì) ‚Üí Notta(1-2ÊôÇÈñì)',
            subTasks: [
                { name: 'MakeMKVÂá¶ÁêÜ', completed: false },
                { name: 'HandBrakeÂ§âÊèõ', completed: false },
                { name: 'NottaÊñáÂ≠óËµ∑„Åì„Åó', completed: false }
            ]
        },
        {
            title: `${genre} „Ç≠„É£„É©„ÇØ„Çø„ÉºÂàÜÊûê`,
            type: 'analysis',
            duration: 2,
            estimatedPomodoros: 4,
            priority: 'medium',
            details: '„Çª„É™„Éï„Åã„ÇâÊÄßÊ†ºÁâπÊÄß„ÇíÊäΩÂá∫„ÉªÂàÜÊûê',
            subTasks: [
                { name: '‰∏ªË¶Å„Ç≠„É£„É©„ÅÆÊÄßÊ†ºÂàÜÊûê', completed: false },
                { name: 'Èñ¢‰øÇÊÄß„ÅÆÊï¥ÁêÜ', completed: false }
            ]
        },
        {
            title: `${genre} Â±ïÈñã„Éª‰∏ñÁïåË¶≥ÂàÜÊûê`,
            type: 'analysis',
            duration: 2,
            estimatedPomodoros: 4,
            priority: 'medium',
            details: '„Çπ„Éà„Éº„É™„ÉºÊßãÈÄ†„Å®‰∏ñÁïåË¶≥„ÅÆÊääÊè°',
            subTasks: [
                { name: '„Éó„É≠„ÉÉ„ÉàÂàÜÊûê', completed: false },
                { name: '‰∏ñÁïåË¶≥Ë®≠ÂÆö„ÅÆÊï¥ÁêÜ', completed: false }
            ]
        },
        {
            title: `${genre} ‰ºèÁ∑öÂ±ïÈñã„Éï„Ç°„Ç§„É´`,
            type: 'planning',
            duration: 3,
            estimatedPomodoros: 6,
            priority: 'high',
            details: '3-5Á´†ÊßãÊàê„ÅÆ‰ΩúÊàê',
            subTasks: [
                { name: 'Á´†ÊßãÊàê„ÅÆÊ±∫ÂÆö', completed: false },
                { name: '‰ºèÁ∑ö„ÅÆÈÖçÁΩÆ', completed: false },
                { name: '„ÇØ„É©„Ç§„Éû„ÉÉ„ÇØ„Çπ„ÅÆË®≠Ë®à', completed: false }
            ]
        },
        {
            title: `${genre} Â§¢Â∞èË™¨Âü∑Á≠Ü`,
            type: 'writing',
            duration: 10,
            estimatedPomodoros: 20,
            priority: 'high',
            details: 'ÂêÑÁ´†3-5Ë©±„ÄÅ1Ë©±8000Â≠óÁõÆÂÆâÔºàÂêàË®à72,000Â≠óÔºâ',
            subTasks: [
                { name: 'Á¨¨1Á´†Âü∑Á≠Ü', completed: false },
                { name: 'Á¨¨2Á´†Âü∑Á≠Ü', completed: false },
                { name: 'Á¨¨3Á´†Âü∑Á≠Ü', completed: false }
            ]
        }
    ];
    
    let currentDate = new Date(today);
    return taskTemplates.map((template, index) => {
        const task = {
            id: `${genre}-${Date.now()}-${index}`,
            genre: genre,
            ...template,
            startDate: currentDate.toISOString().split('T')[0],
            endDate: new Date(currentDate.getTime() + (template.duration - 1) * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
            progress: 0,
            pomodoroSessions: 0,
            completed: false
        };
        currentDate = new Date(currentDate.getTime() + template.duration * 24 * 60 * 60 * 1000);
        return task;
    });
}
    // „Çø„Çπ„ÇØË°®Á§∫
function renderTasks() {
    const taskList = document.getElementById('taskList');
    taskList.innerHTML = '';
    
    Object.entries(tasks).forEach(([genre, genreTasks]) => {
        if (selectedGenre !== 'ÂÖ®‰Ωì' && selectedGenre !== genre) return;
        
        const genreSection = document.createElement('div');
        genreSection.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
                <h3 style="color: white;">${genre}</h3>
                <button class="btn btn-success btn-small" onclick="showAddTaskModal('${genre}')">
                    + „Çø„Çπ„ÇØËøΩÂä†
                </button>
            </div>
        `;
        
        genreTasks.forEach(task => {
            const taskCard = createTaskCard(task);
            genreSection.appendChild(taskCard);
        });
        
        taskList.appendChild(genreSection);
    });
}

// „Çø„Çπ„ÇØ„Ç´„Éº„Éâ‰ΩúÊàê
function createTaskCard(task) {
    const card = document.createElement('div');
    const isOverdue = new Date(task.endDate) < new Date() && !task.completed;
    card.className = `task-card ${task.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}`;
    
    const deadlineClass = getDeadlineClass(task.endDate);
    const deadlineText = new Date(task.endDate).toLocaleDateString('ja-JP');
    
    card.innerHTML = `
        <div class="task-header">
            <div style="display: flex; align-items: center; flex: 1;">
                <input type="checkbox" class="checkbox" ${task.completed ? 'checked' : ''}
                    onchange="toggleTask('${task.id}')">
                <div class="task-title" onclick="showTaskDetail('${task.id}')">${task.title}</div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="task-deadline ${deadlineClass}">${deadlineText}</div>
                <div class="task-actions">
                    <button class="btn btn-danger btn-small" onclick="deleteTask('${task.id}')">ÂâäÈô§</button>
                </div>
            </div>
        </div>
        <div style="font-size: 12px; color: #666; margin: 5px 0;">${task.details}</div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: ${task.progress}%"></div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 12px;">üçÖ ${task.pomodoroSessions}/${task.estimatedPomodoros}</span>
            <button class="btn btn-primary btn-small" onclick="startTaskPomodoro('${task.id}')">
                ${currentTaskId === task.id && pomodoroActive ? '‰ΩúÊ•≠‰∏≠' : '‰ΩúÊ•≠ÈñãÂßã'}
            </button>
        </div>
    `;
    
    return card;
}

// ÊúüÈôê„ÇØ„É©„ÇπÂà§ÂÆö
function getDeadlineClass(endDate) {
    const today = new Date();
    const deadline = new Date(endDate);
    const daysLeft = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
    
    if (daysLeft < 0) return 'deadline-overdue';
    if (daysLeft <= 2) return 'deadline-urgent';
    if (daysLeft <= 5) return 'deadline-soon';
    return 'deadline-normal';
}

// ÊúüÈôêÂàá„Çå„Çø„Çπ„ÇØ„ÉÅ„Çß„ÉÉ„ÇØ
function checkOverdueTasks() {
    const overdueTasks = [];
    Object.values(tasks).forEach(genreTasks => {
        genreTasks.forEach(task => {
            if (new Date(task.endDate) < new Date() && !task.completed) {
                overdueTasks.push(task);
            }
        });
    });
    
    if (overdueTasks.length > 0) {
        document.getElementById('overdueAlert').style.display = 'block';
        document.getElementById('overdueList').innerHTML = overdueTasks.map(task =>
            `<div style="margin: 5px 0;">‚Ä¢ ${task.title} (${new Date(task.endDate).toLocaleDateString('ja-JP')}ÊúüÈôê)</div>`
        ).join('');
    } else {
        document.getElementById('overdueAlert').style.display = 'none';
    }
}

// ÊúüÈôêÂÜçË®≠ÂÆö
function rescheduleOverdue() {
    const today = new Date();
    Object.keys(tasks).forEach(genre => {
        tasks[genre] = tasks[genre].map(task => {
            if (new Date(task.endDate) < today && !task.completed) {
                const duration = Math.ceil((new Date(task.endDate) - new Date(task.startDate)) / (1000 * 60 * 60 * 24));
                task.startDate = today.toISOString().split('T')[0];
                task.endDate = new Date(today.getTime() + duration * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            }
            return task;
        });
    });
    renderTasks();
    checkOverdueTasks();
    alert('ÊúüÈôê„ÇíÂÜçË®≠ÂÆö„Åó„Åæ„Åó„ÅüÔºÅÊñ∞„Åó„ÅÑÊúüÈôê„ÅßÈ†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜÔºÅ');
    autoSave();
}

// „Çø„Çπ„ÇØË©≥Á¥∞Ë°®Á§∫
function showTaskDetail(taskId) {
    let task = null;
    Object.values(tasks).forEach(genreTasks => {
        const found = genreTasks.find(t => t.id === taskId);
        if (found) task = found;
    });
    
    if (!task) return;
    
    currentDetailTask = task;
    document.getElementById('detailTitle').textContent = task.title;
    
    const content = document.getElementById('detailContent');
    content.innerHTML = `
        <div style="margin-bottom: 15px;">
            <strong>ÊúüÈñì:</strong> ${task.startDate} „Äú ${task.endDate}<br>
            <strong>ÈÄ≤Êçó:</strong> ${Math.round(task.progress)}%<br>
            <strong>„Éù„É¢„Éâ„Éº„É≠:</strong> ${task.pomodoroSessions}/${task.estimatedPomodoros}
        </div>
        <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
            <strong>‰ΩúÊ•≠Ë©≥Á¥∞:</strong><br>
            ${task.details}
        </div>
        ${task.subTasks ? `
            <div>
                <strong>„Çµ„Éñ„Çø„Çπ„ÇØ:</strong>
                ${task.subTasks.map((sub, idx) => `
                    <div class="subtask-item">
                        <input type="checkbox" class="subtask-checkbox"
                            ${sub.completed ? 'checked' : ''}
                            onchange="toggleSubtask('${task.id}', ${idx})">
                        <span>${sub.name}</span>
                    </div>
                `).join('')}
            </div>
        ` : ''}
    `;
    
    const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
    document.getElementById('motivationalQuote').textContent = `"${randomQuote}"`;
    
    document.getElementById('detailModal').style.display = 'flex';
}

// „Çµ„Éñ„Çø„Çπ„ÇØÂàá„ÇäÊõø„Åà
function toggleSubtask(taskId, subIndex) {
    Object.keys(tasks).forEach(genre => {
        tasks[genre] = tasks[genre].map(task => {
            if (task.id === taskId && task.subTasks) {
                task.subTasks[subIndex].completed = !task.subTasks[subIndex].completed;
                const completedSubs = task.subTasks.filter(s => s.completed).length;
                task.progress = Math.max(task.progress, (completedSubs / task.subTasks.length) * 50);
            }
            return task;
        });
    });
    updateStats();
    autoSave();
}

// Ë©≥Á¥∞„Åã„Çâ„Éù„É¢„Éâ„Éº„É≠ÈñãÂßã
function startDetailPomodoro() {
    if (currentDetailTask) {
        startTaskPomodoro(currentDetailTask.id);
        hideModal('detailModal');
    }
}

// „Çø„Çπ„ÇØËøΩÂä†„É¢„Éº„ÉÄ„É´Ë°®Á§∫
function showAddTaskModal(genre) {
    currentEditGenre = genre;
    document.getElementById('taskModalTitle').textContent = `${genre} - „Çø„Çπ„ÇØËøΩÂä†`;
    document.getElementById('taskModal').style.display = 'flex';
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('taskStartDate').value = today;
    document.getElementById('taskEndDate').value = today;
}

// „Çø„Çπ„ÇØ‰øùÂ≠ò
function saveTask() {
    const task = {
        id: `${currentEditGenre}-${Date.now()}`,
        genre: currentEditGenre,
        title: document.getElementById('taskTitle').value,
        type: document.getElementById('taskType').value,
        startDate: document.getElementById('taskStartDate').value,
        endDate: document.getElementById('taskEndDate').value,
        estimatedPomodoros: parseInt(document.getElementById('taskPomodoros').value),
        priority: document.getElementById('taskPriority').value,
        details: document.getElementById('taskDetails').value,
        progress: 0,
        pomodoroSessions: 0,
        completed: false
    };
    
    tasks[currentEditGenre].push(task);
    renderTasks();
    updateStats();
    hideModal('taskModal');
    
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDetails').value = '';
    autoSave();
}

// „Çø„Çπ„ÇØÂâäÈô§
function deleteTask(taskId) {
    if (confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
        Object.keys(tasks).forEach(genre => {
            tasks[genre] = tasks[genre].filter(task => task.id !== taskId);
        });
        renderTasks();
        updateStats();
        autoSave();
    }
}

// „Çø„Çπ„ÇØÂÆå‰∫ÜÂàá„ÇäÊõø„Åà
function toggleTask(taskId) {
    Object.keys(tasks).forEach(genre => {
        tasks[genre] = tasks[genre].map(task => {
            if (task.id === taskId) {
                task.completed = !task.completed;
                if (task.completed) {
                    task.progress = 100;
                    motivationLevel = Math.min(100, motivationLevel + 10);
                    updateMotivation();
                }
            }
            return task;
        });
    });
    renderTasks();
    updateStats();
    updateProgressSection();
    autoSave();
}
    // „Éù„É¢„Éâ„Éº„É≠„Çø„Ç§„Éû„Éº
function togglePomodoro() {
    pomodoroActive = !pomodoroActive;
    if (pomodoroActive) {
        pomodoroInterval = setInterval(updatePomodoro, 1000);
    } else {
        clearInterval(pomodoroInterval);
    }
}

function updatePomodoro() {
    if (pomodoroTime > 0) {
        pomodoroTime--;
        const minutes = Math.floor(pomodoroTime / 60);
        const seconds = pomodoroTime % 60;
        document.getElementById('pomodoroTime').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
    } else {
        completePomodoro();
    }
}

function completePomodoro() {
    pomodoroActive = false;
    clearInterval(pomodoroInterval);
    pomodoroTime = 25 * 60;
    
    // ‰ªäÊó•„ÅÆÈÄ≤ÊçóÊõ¥Êñ∞
    const today = new Date().toISOString().split('T')[0];
    dailyProgress[today] = (dailyProgress[today] || 0) + 1;
    
    // ÁèæÂú®„ÅÆ„Çø„Çπ„ÇØ„ÅÆÈÄ≤ÊçóÊõ¥Êñ∞
    if (currentTaskId) {
        Object.keys(tasks).forEach(genre => {
            tasks[genre] = tasks[genre].map(task => {
                if (task.id === currentTaskId) {
                    task.pomodoroSessions++;
                    task.progress = Math.min(100, (task.pomodoroSessions / task.estimatedPomodoros) * 100);
                }
                return task;
            });
        });
    }
    
    motivationLevel = Math.min(100, motivationLevel + 5);
    updateMotivation();
    updateTodayProgress();
    renderTasks();
    updateStats();
    updateProgressSection();
    
    alert('üéâ „Éù„É¢„Éâ„Éº„É≠ÂÆå‰∫ÜÔºÅ5ÂàÜ‰ºëÊÜ©„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    autoSave();
}

function startTaskPomodoro(taskId) {
    currentTaskId = taskId;
    if (!pomodoroActive) {
        togglePomodoro();
    }
}

// ÈÄ≤ÊçóÁä∂Ê≥ÅÊõ¥Êñ∞
function updateProgressSection() {
    // ÁèæÂú®„ÅÆÊ≥®Âäõ„Çø„Çπ„ÇØ
    const activeTasks = [];
    Object.values(tasks).forEach(genreTasks => {
        genreTasks.forEach(task => {
            if (!task.completed && task.pomodoroSessions > 0) {
                activeTasks.push(task);
            }
        });
    });
    
    const focusElement = document.getElementById('currentFocus');
    if (activeTasks.length > 0) {
        const mostActive = activeTasks.sort((a, b) => b.pomodoroSessions - a.pomodoroSessions)[0];
        focusElement.innerHTML = `üî• ÁèæÂú®Ê≥®Âäõ‰∏≠: <strong>${mostActive.title}</strong> (${mostActive.pomodoroSessions}„Éù„É¢„Éâ„Éº„É≠ÂÆüÊñΩ)`;
    } else {
        focusElement.innerHTML = 'üìù „Åæ„Å†„Çø„Çπ„ÇØ„ÇíÈñãÂßã„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì';
    }
    
    // „Ç∏„É£„É≥„É´Âà•ÈÄ≤Êçó
    const progressBars = document.getElementById('genreProgressBars');
    progressBars.innerHTML = '';
    
    Object.entries(tasks).forEach(([genre, genreTasks]) => {
        const total = genreTasks.length;
        const completed = genreTasks.filter(t => t.completed).length;
        const percentage = total > 0 ? (completed / total * 100) : 0;
        
        progressBars.innerHTML += `
            <div class="genre-progress">
                <div style="display: flex; justify-content: space-between;">
                    <span>${genre}</span>
                    <span>${completed}/${total} ÂÆå‰∫Ü</span>
                </div>
                <div class="genre-progress-bar">
                    <div class="genre-progress-fill" style="width: ${percentage}%"></div>
                </div>
            </div>
        `;
    });
}

// ‰ªäÊó•„ÅÆÈÄ≤ÊçóÊõ¥Êñ∞
function updateTodayProgress() {
    const today = new Date().toISOString().split('T')[0];
    const todayCount = dailyProgress[today] || 0;
    
    document.getElementById('todayCount').textContent = todayCount;
    
    const dots = document.querySelectorAll('.pomodoro-dot');
    dots.forEach((dot, index) => {
        if (index < todayCount) {
            dot.classList.add('filled');
        } else {
            dot.classList.remove('filled');
        }
    });
}

// „Ç´„É¨„É≥„ÉÄ„ÉºË°®Á§∫
function showCalendarModal() {
    const calendar = document.getElementById('calendarContent');
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    
    let html = '<div class="calendar">';
    
    // ÊõúÊó•„Éò„ÉÉ„ÉÄ„Éº
    const weekDays = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
    weekDays.forEach(day => {
        html += `<div style="font-weight: bold; text-align: center; padding: 5px;">${day}</div>`;
    });
    
    // ÊúàÂàù„ÅÆÁ©∫ÁôΩ
    for (let i = 0; i < firstDay.getDay(); i++) {
        html += '<div></div>';
    }
    
    // Êó•‰ªò
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = date.toISOString().split('T')[0];
        const pomodoros = dailyProgress[dateStr] || 0;
        const isToday = day === today.getDate();
        
        let emoji = '';
        if (pomodoros >= 8) emoji = 'üèÜ';
        else if (pomodoros >= 4) emoji = '‚≠ê';
        else if (pomodoros > 0) emoji = '‚úì';
        
        html += `
            <div class="calendar-day ${isToday ? 'today' : ''}">
                <div class="calendar-day-number">${day}</div>
                ${emoji ? `<div>${emoji}</div>` : ''}
                ${pomodoros > 0 ? `<div class="calendar-day-pomodoros">${pomodoros}üçÖ</div>` : ''}
            </div>
        `;
    }
    
    html += '</div>';
    calendar.innerHTML = html;
    document.getElementById('calendarModal').style.display = 'flex';
}

// „É¢„ÉÅ„Éô„Éº„Ç∑„Éß„É≥Êõ¥Êñ∞
function updateMotivation() {
    document.getElementById('motivationBar').style.width = `${motivationLevel}%`;
    let text = '';
    if (motivationLevel >= 90) text = 'üî• Áµ∂Â•ΩË™øÔºÅ';
    else if (motivationLevel >= 70) text = '‚≠ê „ÅÑ„ÅÑÊÑü„ÅòÔºÅ';
    else if (motivationLevel >= 50) text = 'üíñ „Åù„ÅÆË™øÂ≠êÔºÅ';
    else text = '‚òï ‰ºëÊÜ©„ÇÇÂ§ßÂàá';
    document.getElementById('motivationText').textContent = `${text} ${motivationLevel}%`;
}

// Áµ±Ë®àÊõ¥Êñ∞
function updateStats() {
    let completed = 0;
    let pomodoros = 0;
    let words = 0;
    
    Object.values(tasks).forEach(genreTasks => {
        genreTasks.forEach(task => {
            if (task.completed) completed++;
            pomodoros += task.pomodoroSessions;
            if (task.type === 'writing') {
                words += Math.floor(task.progress * 720);
            }
        });
    });
    
    document.getElementById('completedCount').textContent = completed;
    document.getElementById('pomodoroCount').textContent = pomodoros;
    document.getElementById('wordCount').textContent = words.toLocaleString();
}

// AI„Ç¢„Éâ„Éê„Ç§„ÇπÊõ¥Êñ∞
function updateAIAdvice() {
    const allTasks = Object.values(tasks).flat().filter(t => !t.completed);
    const sortedTasks = allTasks.sort((a, b) => {
        const scoreA = calculatePriority(a);
        const scoreB = calculatePriority(b);
        return scoreB - scoreA;
    });
    
    const advice = document.getElementById('aiAdvice');
    if (sortedTasks.length > 0) {
        advice.innerHTML = sortedTasks.slice(0, 3).map((task, index) =>
            `<div style="padding: 5px 0;">
                <strong>#${index + 1}</strong> ${task.title}
                <span style="font-size: 12px; color: #666;">
                    (ÊúüÈôê: ${new Date(task.endDate).toLocaleDateString('ja-JP')})
                </span>
            </div>`
        ).join('');
    } else {
        advice.innerHTML = '„Åô„Åπ„Å¶„ÅÆ„Çø„Çπ„ÇØ„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„ÅôÔºÅüéâ';
    }
}

function calculatePriority(task) {
    const today = new Date();
    const deadline = new Date(task.endDate);
    const daysLeft = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
    
    let score = 0;
    if (daysLeft < 0) score += 100;
    else if (daysLeft <= 2) score += 80;
    else if (daysLeft <= 5) score += 50;
    
    if (task.priority === 'high') score += 40;
    else if (task.priority === 'medium') score += 20;
    
    return score;
}

// „Ç∏„É£„É≥„É´ÈÅ∏Êäû
function selectGenre(genre) {
    selectedGenre = genre;
    document.querySelectorAll('.genre-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent === genre) {
            tab.classList.add('active');
        }
    });
    renderTasks();
}

// „Ç∏„É£„É≥„É´ËøΩÂä†„É¢„Éº„ÉÄ„É´
function showAddGenreModal() {
    document.getElementById('genreModal').style.display = 'flex';
}

function hideModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function addGenre() {
    const input = document.getElementById('genreInput');
    const genreName = input.value.trim();
    
    if (genreName && !genres.includes(genreName)) {
        genres.push(genreName);
        tasks[genreName] = generateTasksForGenre(genreName);
        
        // „Çø„ÉñËøΩÂä†
        const tabsContainer = document.querySelector('.genre-tabs');
        const newTab = document.createElement('div');
        newTab.className = 'genre-tab';
        newTab.textContent = genreName;
        newTab.onclick = () => selectGenre(genreName);
        tabsContainer.insertBefore(newTab, tabsContainer.lastElementChild);
        
        renderTasks();
        updateStats();
        updateProgressSection();
        motivationLevel = Math.min(100, motivationLevel + 10);
        updateMotivation();
    }
    
    input.value = '';
    hideModal('genreModal');
    autoSave();
}

// ===== ÂàùÊúüÂåñÂÆüË°å =====
window.addEventListener('DOMContentLoaded', () => {
    init();
});

// Ëá™Âãï‰øùÂ≠òË®≠ÂÆö
window.addEventListener('beforeunload', () => {
    saveAllData();
});

// ÂÆöÊúüÁöÑ„Å™Ëá™Âãï‰øùÂ≠òÔºà1ÂàÜ„Åî„Å®Ôºâ
setInterval(() => {
    saveAllData();
}, 60000);

</script>

</body>
</html>

</body>
</html>
   
